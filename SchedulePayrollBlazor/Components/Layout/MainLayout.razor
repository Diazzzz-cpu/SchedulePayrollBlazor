@inherits LayoutComponentBase
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization

@inject IJSRuntime JS

<div class="ps-app">
    <AuthorizeView>
        <Authorized>
            <aside class="ps-sidebar">
                <div class="ps-brand">
                    <span class="ps-brand-name">PaySync</span>
                    <span class="ps-brand-subtitle">Payroll &amp; Scheduling</span>
                </div>

                <NavMenu />
            </aside>

            <div class="ps-main">
                <header class="ps-topbar">
                    <div class="ps-topbar-branding">
                        <span class="ps-topbar-title">PaySync</span>
                        <span class="ps-topbar-tagline">Integrated workforce hub</span>
                    </div>
                    <div class="ps-topbar-actions">
                        <div class="ps-topbar-meta">Internal payroll &amp; scheduling</div>
                    </div>
                </header>

                <main class="ps-content">
                    <div class="ps-content-inner">
                        @Body
                    </div>
                </main>
            </div>
        </Authorized>
        <NotAuthorized>
            <div class="ps-public-shell">
                <div class="ps-brand ps-public-brand">
                    <span class="ps-brand-name">PaySync</span>
                    <span class="ps-brand-subtitle">Welcome</span>
                </div>
                <main class="ps-public-content">
                    @Body
                </main>
            </div>
        </NotAuthorized>
    </AuthorizeView>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private bool _isAuthenticated;
    private bool _syncRequested = true;

    protected override async Task OnParametersSetAsync()
    {
        var previous = _isAuthenticated;
        _isAuthenticated = await DetermineAuthenticationAsync();

        if (_isAuthenticated != previous)
        {
            _syncRequested = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || _syncRequested)
        {
            await SyncThemeAsync();
            _syncRequested = false;
        }
    }

    private async Task<bool> DetermineAuthenticationAsync()
    {
        if (AuthenticationStateTask is null)
        {
            return false;
        }

        try
        {
            var state = await AuthenticationStateTask;
            return state.User?.Identity?.IsAuthenticated ?? false;
        }
        catch
        {
            return false;
        }
    }

    private async Task SyncThemeAsync()
    {
        try
        {
            await JS.InvokeAsync<string>("paySyncTheme.init");
        }
        catch (JSException)
        {
            // Ignore failures to update theme gracefully.
        }
    }
}
