@inherits LayoutComponentBase
@using Microsoft.JSInterop

@inject IJSRuntime JS

<div class="ps-app">
    <AuthorizeView>
        <Authorized>
            <aside class="ps-sidebar">
                <div class="ps-brand">
                    <span class="ps-brand-name">PaySync</span>
                    <span class="ps-brand-subtitle">Payroll &amp; Scheduling</span>
                </div>

                <NavMenu />
            </aside>
        </Authorized>
        <NotAuthorized>
            <aside class="ps-sidebar ps-sidebar-compact">
                <div class="ps-brand">
                    <span class="ps-brand-name">PaySync</span>
                    <span class="ps-brand-subtitle">Sign in to continue</span>
                </div>

                <nav class="ps-nav">
                    <div class="ps-nav-section">
                        <ul class="ps-nav-list">
                            <li>
                                <NavLink href="/login" class="ps-nav-link" activeClass="active">Login</NavLink>
                            </li>
                        </ul>
                    </div>
                </nav>
            </aside>
        </NotAuthorized>
    </AuthorizeView>

    <div class="ps-main">
        <header class="ps-topbar">
            <div class="ps-topbar-branding">
                <span class="ps-topbar-title">PaySync</span>
                <span class="ps-topbar-tagline">Integrated workforce hub</span>
            </div>
            <div class="ps-topbar-actions">
                <div class="ps-topbar-meta">Internal payroll &amp; scheduling</div>
                <button type="button"
                        class="ps-theme-toggle"
                        @onclick="ToggleTheme"
                        aria-pressed="@_isDark.ToString().ToLowerInvariant()"
                        aria-label="@ThemeButtonAriaLabel"
                        title="Toggle light or dark theme">
                    @ThemeButtonLabel
                </button>
            </div>
        </header>

        <main class="ps-content">
            <div class="ps-content-inner">
                @Body
            </div>
        </main>
    </div>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    private bool _isDark;
    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeThemeAsync();
            StateHasChanged();
        }
    }

    private async Task ToggleTheme()
    {
        if (!_initialized)
        {
            await InitializeThemeAsync();
            StateHasChanged();
            return;
        }

        try
        {
            var theme = await JS.InvokeAsync<string>("paySyncTheme.toggle");
            _isDark = string.Equals(theme, "dark", StringComparison.OrdinalIgnoreCase);
        }
        catch (JSException)
        {
            _isDark = !_isDark;
        }
        StateHasChanged();
    }

    private async Task InitializeThemeAsync()
    {
        try
        {
            var theme = await JS.InvokeAsync<string>("paySyncTheme.init");
            _isDark = string.Equals(theme, "dark", StringComparison.OrdinalIgnoreCase);
        }
        catch (JSException)
        {
            _isDark = false;
        }

        _initialized = true;
    }

    private string ThemeButtonLabel => _isDark ? "â˜€ Light mode" : "ðŸŒ™ Dark mode";
    private string ThemeButtonAriaLabel => _isDark ? "Switch to light theme" : "Switch to dark theme";
}
