@page "/settings/attendance"
@attribute [Authorize(Roles = "Admin")]
@using System.ComponentModel.DataAnnotations
@using SchedulePayrollBlazor.Data.Models

@inject IAttendanceSettingsService AttendanceSettingsService

<div class="ps-page">
    <div class="ps-page-header">
        <div>
            <h2>Attendance penalties &amp; bonuses</h2>
            <p class="ps-subtitle">Configure automatic deductions and bonuses based on attendance.</p>
        </div>
    </div>

    <section class="ps-card">
        <EditForm Model="model" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            @if (!string.IsNullOrEmpty(alertMessage))
            {
                <div class="alert @(alertIsError ? "alert-danger" : "alert-success")">@alertMessage</div>
            }

            <!-- ðŸŒŸ SCOPE THESE TO THIS PAGE ONLY -->
            <div class="ps-attendance-form-grid">

                <!-- Late Penalty -->
                <div class="ps-attendance-form-row">
                    <div class="ps-attendance-form-label">
                        <label class="ps-label">Late penalty (per 30 minutes)</label>
                        <p class="ps-help-text">Converted to a per-minute rate when saved.</p>
                    </div>
                    <div class="ps-attendance-form-control">
                        <div class="ps-input-group">
                            <span class="ps-input-prefix">â‚±</span>
                            <InputNumber @bind-Value="model.LatePenaltyPerHalfHour" class="ps-input" step="0.01" min="0" />
                            <span class="ps-input-suffix">per 30 min</span>
                        </div>
                    </div>
                </div>

                <!-- Undertime -->
                <div class="ps-attendance-form-row">
                    <div class="ps-attendance-form-label">
                        <label class="ps-label">Undertime penalty (per hour)</label>
                        <p class="ps-help-text">Applied when an employee leaves early beyond grace minutes.</p>
                    </div>
                    <div class="ps-attendance-form-control">
                        <div class="ps-input-group">
                            <span class="ps-input-prefix">â‚±</span>
                            <InputNumber @bind-Value="model.UndertimePenaltyPerHour" class="ps-input" step="0.01" min="0" />
                            <span class="ps-input-suffix">per hour</span>
                        </div>
                    </div>
                </div>

                <!-- Absence -->
                <div class="ps-attendance-form-row">
                    <div class="ps-attendance-form-label">
                        <label class="ps-label">Absence multiplier (full day)</label>
                        <p class="ps-help-text">Multiplier against daily base pay for scheduled hours.</p>
                    </div>
                    <div class="ps-attendance-form-control">
                        <div class="ps-input-group">
                            <InputNumber @bind-Value="model.AbsenceFullDayMultiplier" class="ps-input" step="0.01" min="0" />
                            <span class="ps-input-suffix">Ã— daily pay</span>
                        </div>
                    </div>
                </div>

                <!-- Overtime -->
                <div class="ps-attendance-form-row">
                    <div class="ps-attendance-form-label">
                        <label class="ps-label">Overtime bonus (per hour)</label>
                        <p class="ps-help-text">Reward for approved overtime beyond the threshold.</p>
                    </div>
                    <div class="ps-attendance-form-control">
                        <div class="ps-input-group">
                            <span class="ps-input-prefix">â‚±</span>
                            <InputNumber @bind-Value="model.OvertimeBonusPerHour" class="ps-input" step="0.01" min="0" />
                            <span class="ps-input-suffix">per hour</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ps-attendance-form-footer">
                <button class="btn btn-primary" type="submit">Save changes</button>
                <span class="text-muted align-self-center">Last updated: @lastUpdatedLabel</span>
            </div>
        </EditForm>
    </section>
</div>

@code {
    private AttendanceSettingsModel model = new();
    private string? alertMessage;
    private bool alertIsError;
    private string lastUpdatedLabel = "â€”";

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        try
        {
            var settings = await AttendanceSettingsService.GetOrCreateAsync();
            model = new AttendanceSettingsModel
            {
                LatePenaltyPerHalfHour = Math.Round(settings.LatePenaltyPerMinute * 30m, 2),
                UndertimePenaltyPerHour = Math.Round(settings.UndertimePenaltyPerMinute * 60m, 2),
                AbsenceFullDayMultiplier = settings.AbsenceFullDayMultiplier,
                OvertimeBonusPerHour = Math.Round(settings.OvertimeBonusPerMinute * 60m, 2)
            };
            lastUpdatedLabel = settings.UpdatedAt == default
                ? "Not set"
                : settings.UpdatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm");
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Unable to load settings: {ex.Message}";
        }
    }

    private async Task SaveAsync()  
    {
        try
        {
            var settings = new AttendancePenaltySettings
            {
                LatePenaltyPerMinute = model.LatePenaltyPerHalfHour / 30m,
                UndertimePenaltyPerMinute = model.UndertimePenaltyPerHour / 60m,
                AbsenceFullDayMultiplier = model.AbsenceFullDayMultiplier,
                OvertimeBonusPerMinute = model.OvertimeBonusPerHour / 60m
            };
            var updated = await AttendanceSettingsService.UpdateAsync(settings);
            alertIsError = false;
            alertMessage = "Attendance penalty settings updated.";
            lastUpdatedLabel = updated.UpdatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm");
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Unable to save settings: {ex.Message}";
        }
    }

    private sealed class AttendanceSettingsModel
    {
        [Range(0, double.MaxValue)]
        public decimal LatePenaltyPerHalfHour { get; set; }
        [Range(0, double.MaxValue)]
        public decimal UndertimePenaltyPerHour { get; set; }
        [Range(0, double.MaxValue)]
        public decimal AbsenceFullDayMultiplier { get; set; }
        [Range(0, double.MaxValue)]
        public decimal OvertimeBonusPerHour { get; set; }
    }
}
