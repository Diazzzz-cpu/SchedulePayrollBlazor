@page "/mypayroll"
@attribute [Authorize(Roles = "Employee")]
@inject AppDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Linq

<div class="ps-page">
    <div class="ps-page-header">
        <div>
            <h2>My payroll</h2>
            <p class="ps-subtitle">Review your payslips and track earnings in PHP.</p>
        </div>
    </div>

    @if (entries is null)
    {
        <div class="ps-card">
            <div class="loading">Loading…</div>
        </div>
    }
    else if (entries.Count == 0)
    {
        <div class="ps-card">
            <div class="text-muted">No payroll records are available yet. Once a payroll period is processed, it will appear here.</div>
        </div>
    }
    else
    {
        <section class="ps-card">
            <div class="ps-card-header">
                <h3>Earnings summary</h3>
                <p class="ps-subtitle">Overview of total and most recent payouts.</p>
            </div>
            <div class="ps-summary-grid">
                <div class="ps-summary-card">
                    <h4>Total net pay (all time)</h4>
                    <p class="ps-summary-value">₱@totalNet.ToString("N2")</p>
                </div>
                <div class="ps-summary-card">
                    <h4>Last payout</h4>
                    <p class="ps-summary-value">₱@lastNet.ToString("N2")</p>
                </div>
                <div class="ps-summary-card">
                    <h4>Average net pay</h4>
                    <p class="ps-summary-value">₱@averageNet.ToString("N2")</p>
                </div>
            </div>
        </section>

        <section class="ps-card">
            <div class="ps-card-header">
                <h3>Payroll history</h3>
                <p class="ps-subtitle">Detailed breakdown per period.</p>
            </div>
            <div class="ps-table-container">
                <table class="ps-table">
                    <thead>
                        <tr>
                            <th>Payroll period</th>
                            <th>Total hours</th>
                            <th>Base pay</th>
                            <th>Deductions</th>
                            <th>Bonuses</th>
                            <th>Net pay</th>
                            <th>Processed</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var entry in entries)
                        {
                            <tr>
                                <td>
                                    <div class="fw-semibold">@(entry.PayrollPeriod?.Name ?? "Payroll period")</div>
                                    <div class="text-muted">
                                        @if (entry.PayrollPeriod is not null)
                                        {
                                            <span>@entry.PayrollPeriod.StartDate.ToString("MMM dd, yyyy") – @entry.PayrollPeriod.EndDate.ToString("MMM dd, yyyy")</span>
                                        }
                                        else
                                        {
                                            <span>—</span>
                                        }
                                    </div>
                                </td>
                                <td>@string.Format("{0:N2} hrs", entry.TotalHoursWorked)</td>
                                <td>₱@entry.BasePay:N2</td>
                                <td class="text-danger">₱@entry.TotalDeductions:N2</td>
                                <td class="text-success">₱@entry.TotalBonuses:N2</td>
                                <td><strong>₱@entry.NetPay:N2</strong></td>
                                <td>@entry.CalculatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</td>
                            </tr>
                            @if (entry.Adjustments is not null && entry.Adjustments.Count > 0)
                            {
                                <tr class="ps-table-row-detail">
                                    <td colspan="7">
                                        <strong>Adjustments applied:</strong>
                                        <ul class="adjustment-list">
                                            @foreach (var adjustment in entry.Adjustments.OrderByDescending(a => a.Type))
                                            {
                                                <li>
                                                    <span class="badge @(IsBonus(adjustment) ? "badge-success" : "badge-danger")">@adjustment.Type</span>
                                                    <span class="adjustment-label">@adjustment.Label</span>
                                                    <span class="adjustment-amount">₱@adjustment.Amount:N2</span>
                                                </li>
                                            }
                                        </ul>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </section>
    }
</div>

@code {
    private List<PayrollEntry>? entries;
    private decimal totalNet;
    private decimal lastNet;
    private decimal averageNet;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var role = user.FindFirst(ClaimTypes.Role)?.Value;
        if (!string.Equals(role, "Employee", StringComparison.OrdinalIgnoreCase))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        var employeeIdClaim = user.FindFirst("EmployeeId")?.Value ?? user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!int.TryParse(employeeIdClaim, out var employeeId))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        entries = await Db.PayrollEntries
            .Include(e => e.PayrollPeriod)
            .Include(e => e.Adjustments)
            .Where(e => e.EmployeeId == employeeId)
            .OrderByDescending(e => e.PayrollPeriod.EndDate)
            .ThenByDescending(e => e.CalculatedAt)
            .ToListAsync();

        totalNet = entries.Sum(e => e.NetPay);
        lastNet = entries.FirstOrDefault()?.NetPay ?? 0m;
        averageNet = entries.Count == 0 ? 0m : entries.Average(e => e.NetPay);
    }

    private static bool IsBonus(PayrollAdjustment adjustment)
        => string.Equals(adjustment.Type, "Bonus", StringComparison.OrdinalIgnoreCase);
}
