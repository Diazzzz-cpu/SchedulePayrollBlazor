@page "/mypayroll"
@attribute [Authorize(Roles = "Employee")]
@inject AppDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore
@using SchedulePayrollBlazor.Data.Models
@using System.Security.Claims

<div class="page-container">
    <div class="page-header">
        <h2>My Payroll</h2>
        <p>View your payroll information</p>
    </div>

    @if (payrollRuns == null)
    {
        <div class="loading">Loading...</div>
    }
    else if (!payrollRuns.Any())
    {
        <div class="alert alert-info">No payroll records found.</div>
    }
    else
    {
        <div class="payroll-summary">
            <div class="summary-card">
                <h4>Total Earnings (All Time)</h4>
                <h2>$@totalEarnings.ToString("N2")</h2>
            </div>
            <div class="summary-card">
                <h4>Last Paycheck</h4>
                <h2>$@lastPaycheck.ToString("N2")</h2>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Pay Period</th>
                        <th>Gross Pay</th>
                        <th>Deductions</th>
                        <th>Net Pay</th>
                        <th>Status</th>
                        <th>Processed</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var run in payrollRuns)
                    {
                        <tr>
                            <td>
                                @if (run.PayPeriod != null)
                                {
                                    <div>@run.PayPeriod.PeriodName</div>
                                    <small class="text-muted">
                                        @run.PayPeriod.StartDate.ToString("MMM dd") - @run.PayPeriod.EndDate.ToString("MMM dd, yyyy")
                                    </small>
                                }
                                else
                                {
                                    <div>Ad hoc</div>
                                }
                            </td>
                            <td class="text-success">$@run.GrossPay.ToString("N2")</td>
                            <td class="text-danger">$@run.TotalDeductions.ToString("N2")</td>
                            <td><strong>$@run.NetPay.ToString("N2")</strong></td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(run.Status)">
                                    @run.Status
                                </span>
                            </td>
                            <td>@run.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private int employeeId;
    private List<PayrollRun>? payrollRuns;
    private decimal totalEarnings;
    private decimal lastPaycheck;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var role = user.FindFirst(ClaimTypes.Role)?.Value;

        if (!string.Equals(role, "Employee", StringComparison.OrdinalIgnoreCase))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        var empIdClaim = user.FindFirst("EmployeeId")?.Value ?? user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!int.TryParse(empIdClaim, out employeeId))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        payrollRuns = await Db.PayrollRuns
            .Include(p => p.PayPeriod)
            .Where(p => p.EmployeeId == employeeId)
            .OrderByDescending(p => p.CreatedAt)
            .ToListAsync();

        totalEarnings = payrollRuns.Sum(p => p.NetPay);
        lastPaycheck = payrollRuns.FirstOrDefault()?.NetPay ?? 0;
    }

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Paid" => "badge-success",
        "Approved" => "badge-info",
        "Calculated" => "badge-warning",
        _ => "badge-secondary"
    };
}
