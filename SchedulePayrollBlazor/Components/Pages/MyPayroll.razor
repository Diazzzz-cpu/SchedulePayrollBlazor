@page "/mypayroll"
@attribute [Authorize(Roles = "Employee")]
@inject AppDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Linq

<div class="ps-page ps-page-payroll">
    <div class="ps-page-header">
        <div>
            <h2>My payroll</h2>
            <p class="ps-subtitle">Review your payslips and track earnings in PHP.</p>
        </div>
    </div>

    @if (entries is null)
    {
        <div class="ps-card">
            <div class="loading">Loading…</div>
        </div>
    }
    else if (entries.Count == 0)
    {
        <div class="ps-card">
            <div class="text-muted">No payroll records are available yet. Once a payroll period is processed, it will appear here.</div>
        </div>
    }
    else
    {
        <section class="ps-card ps-card-payroll-summary">
            <div class="ps-card-header">
                <h3>Earnings summary</h3>
                <p class="ps-subtitle">Overview of total and most recent payouts.</p>
            </div>
            <div class="ps-stat-grid">
                <div class="ps-stat-card ps-stat-card-payroll">
                    <span class="ps-stat-title">Total net pay (all time)</span>
                    <span class="ps-stat-value">₱@totalNet.ToString("N2")</span>
                </div>
                <div class="ps-stat-card ps-stat-card-payroll">
                    <span class="ps-stat-title">Last payout</span>
                    <span class="ps-stat-value">₱@lastNet.ToString("N2")</span>
                </div>
                <div class="ps-stat-card ps-stat-card-payroll">
                    <span class="ps-stat-title">Average net pay</span>
                    <span class="ps-stat-value">₱@averageNet.ToString("N2")</span>
                </div>
            </div>
        </section>

        <section class="ps-card">
            <div class="ps-card-header">
                <h3>Payroll history</h3>
                <p class="ps-subtitle">Detailed breakdown per period.</p>
            </div>
            <div class="payroll-card-grid">
                @foreach (var entry in entries)
                {
                    var earningLines = GetEarningLines(entry).ToList();
                    var deductionLines = GetDeductionLines(entry).ToList();
                    var totalEarnings = earningLines.Sum(l => l.Amount);
                    var totalDeductions = deductionLines.Sum(l => l.Amount);
                    <div class="ps-card payroll-entry-card">
                        <div class="payroll-entry-header">
                            <div>
                                <div class="payroll-period-title">@GetPeriodName(entry)</div>
                                <div class="payroll-period-dates">@GetPeriodRange(entry)</div>
                            </div>
                            <div class="payroll-entry-meta">
                                <span class="ps-badge">@entry.PayrollPeriod?.Name</span>
                                <span class="text-muted">Processed @entry.CalculatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        </div>

                        <div class="payroll-entry-body">
                            <div class="payroll-lines-grid">
                                <div class="payroll-lines-section">
                                    <h5 class="payroll-lines-title">Earnings</h5>
                                    <table class="ps-table ps-table-compact">
                                        <thead>
                                            <tr>
                                                <th>Code</th>
                                                <th>Description</th>
                                                <th>Quantity</th>
                                                <th>Rate</th>
                                                <th class="text-end">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (earningLines.Count == 0)
                                            {
                                                <tr><td colspan="5" class="text-muted">No earnings recorded.</td></tr>
                                            }
                                            else
                                            {
                                                @foreach (var line in earningLines)
                                                {
                                                    <tr>
                                                        <td><span class="ps-badge">@line.Code</span></td>
                                                        <td>@GetDisplayLabel(line)</td>
                                                        <td>@FormatQuantity(line)</td>
                                                        <td>@FormatRate(line)</td>
                                                        <td class="text-end">@FormatAmount(line.Amount)</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div class="payroll-lines-section">
                                    <h5 class="payroll-lines-title">Deductions</h5>
                                    <table class="ps-table ps-table-compact">
                                        <thead>
                                            <tr>
                                                <th>Code</th>
                                                <th>Description</th>
                                                <th>Quantity</th>
                                                <th>Rate</th>
                                                <th class="text-end">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (deductionLines.Count == 0)
                                            {
                                                <tr><td colspan="5" class="text-muted">No deductions recorded.</td></tr>
                                            }
                                            else
                                            {
                                                @foreach (var line in deductionLines)
                                                {
                                                    <tr>
                                                        <td><span class="ps-badge">@line.Code</span></td>
                                                        <td>@GetDisplayLabel(line)</td>
                                                        <td>@FormatQuantity(line)</td>
                                                        <td>@FormatRate(line)</td>
                                                        <td class="text-end">@FormatAmount(line.Amount)</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="payroll-breakdown-summary">
                                <div>Total hours: <strong>@string.Format("{0:N2} hrs", entry.TotalHoursWorked)</strong></div>
                                <div>Subtotal earnings: <strong>@FormatAmount(totalEarnings)</strong></div>
                                <div>Subtotal deductions: <strong class="text-danger">@FormatAmount(totalDeductions)</strong></div>
                                <div>Net pay: <strong>@FormatAmount(totalEarnings - totalDeductions)</strong></div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </section>
    }
</div>

@code {
    private List<PayrollEntry>? entries;
    private decimal totalNet;
    private decimal lastNet;
    private decimal averageNet;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var role = user.FindFirst(ClaimTypes.Role)?.Value;
        if (!string.Equals(role, "Employee", StringComparison.OrdinalIgnoreCase))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        var employeeIdClaim = user.FindFirst("EmployeeId")?.Value ?? user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!int.TryParse(employeeIdClaim, out var employeeId))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        entries = await Db.PayrollEntries
            .Include(e => e.PayrollPeriod)
            .Include(e => e.PayrollLines)
                .ThenInclude(l => l.PayComponent)
            .Where(e => e.EmployeeId == employeeId)
            .OrderByDescending(e => e.PayrollPeriod.EndDate)
            .ThenByDescending(e => e.CalculatedAt)
            .ToListAsync();

        totalNet = entries.Sum(e => e.NetPay);
        lastNet = entries.FirstOrDefault()?.NetPay ?? 0m;
        averageNet = entries.Count == 0 ? 0m : entries.Average(e => e.NetPay);
    }

    private static IEnumerable<PayrollLine> GetEarningLines(PayrollEntry entry)
        => entry.PayrollLines?.Where(l => string.Equals(l.Kind, "Earning", StringComparison.OrdinalIgnoreCase))
        ?? Enumerable.Empty<PayrollLine>();

    private static IEnumerable<PayrollLine> GetDeductionLines(PayrollEntry entry)
        => entry.PayrollLines?.Where(l => string.Equals(l.Kind, "Deduction", StringComparison.OrdinalIgnoreCase))
        ?? Enumerable.Empty<PayrollLine>();

    private static string GetPeriodName(PayrollEntry entry)
        => entry.PayrollPeriod?.Name ?? "Payroll period";

    private static string GetPeriodRange(PayrollEntry entry)
        => entry.PayrollPeriod is null
            ? "—"
            : $"{entry.PayrollPeriod.StartDate:MMM dd, yyyy} – {entry.PayrollPeriod.EndDate:MMM dd, yyyy}";

    private string GetDisplayLabel(PayrollLine line)
    {
        var code = line.Code.ToUpperInvariant();

        return code switch
        {
            "BASE" => "Base pay (rendered hours)",
            "OT" => "Overtime bonus",
            "LATE" => "Late penalty",
            "UNDERTIME" => "Undertime penalty",
            "ABSENCE" => "Absence deduction",
            "SSS" => "SSS contribution",
            "PHIC" => "PhilHealth contribution",
            "HDMF" => "Pag-IBIG contribution",
            "TAX" => "Withholding tax",
            "ND" => "Night differential",
            _ => string.IsNullOrWhiteSpace(line.Description) ? code : line.Description
        };
    }

    private string FormatAmount(decimal amount) => $"₱{amount:N2}";

    private string FormatQuantity(PayrollLine line)
    {
        var code = line.Code.ToUpperInvariant();

        if (code == "LATE" || code == "UNDERTIME" || code == "OT")
        {
            return $"{line.Quantity:N2} mins";
        }

        if (code == "ABSENCE" || code == "BASE")
        {
            return $"{line.Quantity:N2} hrs";
        }

        return line.Quantity == 0 ? "—" : line.Quantity.ToString("N2");
    }

    private string FormatRate(PayrollLine line)
    {
        if (line.Rate == 0)
        {
            return "—";
        }

        var calculationType = line.PayComponent?.CalculationType ?? string.Empty;
        if (string.Equals(calculationType, "PercentageOfBase", StringComparison.OrdinalIgnoreCase) && line.Rate <= 1)
        {
            return line.Rate.ToString("P2");
        }

        return FormatAmount(line.Rate);
    }
}
