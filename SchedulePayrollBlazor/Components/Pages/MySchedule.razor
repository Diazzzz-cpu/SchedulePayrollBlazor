@page "/my-schedule"
@attribute [Authorize]
@using System.Globalization
@using System.Security.Claims
@using SchedulePayrollBlazor.Data.Models
@inject IShiftService ShiftService
@inject AuthenticationStateProvider AuthStateProvider

<div class="ps-schedule-page">
    <div class="ps-schedule-header-bar">
        <div class="ps-schedule-heading">
            <h1 class="ps-schedule-title">My schedule</h1>
            <p class="ps-schedule-subtitle">Review your upcoming shifts and stay prepared for the week ahead.</p>
        </div>
    </div>

    <div class="ps-tabs" role="tablist">
        <button type="button" class="ps-tab ps-tab-active" aria-current="page">My schedule</button>
        <button type="button" class="ps-tab" disabled>Shift history</button>
    </div>

    <div class="ps-filter-row">
        <div class="ps-filter-group">
            <div class="ps-filter-field">
                <span class="ps-filter-label">Date:</span>
                <input type="month" class="ps-filter-control" value="@MonthInputValue" @onchange="OnMonthChanged" />
            </div>
        </div>
    </div>

    <div class="ps-schedule-card">
        <div class="ps-schedule-header">
            <div class="ps-schedule-nav-buttons">
                <button type="button" class="ps-button ps-button-ghost ps-icon-button" @onclick="GoToPreviousWeek" disabled="@_isLoading" aria-label="Previous week">
                    ‹
                </button>
            </div>
            <div class="ps-schedule-week-label">@GetWeekRangeLabel()</div>
            <div class="ps-schedule-nav-buttons">
                <button type="button" class="ps-button ps-button-ghost ps-icon-button" @onclick="GoToNextWeek" disabled="@_isLoading" aria-label="Next week">
                    ›
                </button>
            </div>
        </div>

        @if (_isLoading && !_shifts.Any())
        {
            <div class="ps-schedule-loading">Loading shifts...</div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="ps-alert ps-alert-danger" role="alert">@_errorMessage</div>
        }
        else
        {
            <div class="ps-schedule-grid">
                @foreach (var day in GetWeekDays())
                {
                    var dayShifts = _shifts
                        .Where(s => s.Start.Date == day.Date)
                        .OrderBy(s => s.Start)
                        .ToList();

                    <div class="ps-schedule-column">
                        <div class="ps-schedule-column-header">
                            <div class="ps-schedule-day-name">@day.ToString("ddd", CultureInfo.InvariantCulture)</div>
                            <div class="ps-schedule-day-date">@day.ToString("dd", CultureInfo.InvariantCulture)</div>
                        </div>
                        <div class="ps-schedule-column-body">
                            @if (_isLoading && dayShifts.Count == 0)
                            {
                                <div class="ps-schedule-loading">Loading shifts...</div>
                            }
                            else if (dayShifts.Count == 0)
                            {
                                <div class="ps-schedule-empty">No shifts</div>
                            }
                            else
                            {
                                foreach (var shift in dayShifts)
                                {
                                    <div class="ps-shift-card">
                                        <div class="ps-shift-accent"></div>
                                        <div class="ps-shift-body">
                                            <div class="ps-shift-employee">@ResolveEmployeeLabel(shift)</div>
                                            <div class="ps-shift-time">@shift.Start.ToString("hh:mm tt", CultureInfo.InvariantCulture) – @shift.End.ToString("hh:mm tt", CultureInfo.InvariantCulture)</div>
                                            @if (!string.IsNullOrWhiteSpace(shift.GroupName))
                                            {
                                                <div class="ps-shift-more">@shift.GroupName</div>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>

            @if (!_isLoading && !_shifts.Any())
            {
                <div class="ps-schedule-empty">No shifts scheduled for this week.</div>
            }
        }
    </div>
</div>

@code {
    private readonly List<Shift> _shifts = new();
    private bool _isLoading;
    private string? _errorMessage;
    private int _employeeId;
    private string? _employeeName;
    private DateTime _weekStart;
    private DateTime _selectedMonth;

    private string MonthInputValue => _selectedMonth.ToString("yyyy-MM", CultureInfo.InvariantCulture);

    protected override async Task OnInitializedAsync()
    {
        var today = DateTime.Today;
        _weekStart = StartOfWeek(today);
        _selectedMonth = new DateTime(today.Year, today.Month, 1);

        await LoadEmployeeAsync();

        if (_employeeId > 0 && string.IsNullOrEmpty(_errorMessage))
        {
            await RefreshShiftsAsync();
        }
    }

    private async Task LoadEmployeeAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        _employeeId = 0;

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!(user.Identity?.IsAuthenticated ?? false))
            {
                _errorMessage = "You must be logged in to view your schedule.";
                return;
            }

            var displayName = user.Identity?.Name ?? user.FindFirst(ClaimTypes.Email)?.Value;
            _employeeName = string.IsNullOrWhiteSpace(displayName) ? null : displayName.Trim();

            var employeeIdClaim = user.FindFirst("EmployeeId")?.Value;
            if (int.TryParse(employeeIdClaim, out var parsedEmployeeId))
            {
                _employeeId = parsedEmployeeId;
                return;
            }

            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            var email = user.FindFirst(ClaimTypes.Email)?.Value;

            var resolvedEmployeeId = await ShiftService.ResolveEmployeeIdForUserAsync(userIdClaim, email);
            if (resolvedEmployeeId.HasValue)
            {
                _employeeId = resolvedEmployeeId.Value;
            }
            else
            {
                _errorMessage = "We couldn't find your employee record.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task RefreshShiftsAsync()
    {
        if (_employeeId <= 0)
        {
            _shifts.Clear();
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var weekEnd = _weekStart.AddDays(7);
            var result = await ShiftService.GetShiftsForEmployeeAsync(_employeeId, _weekStart, weekEnd);

            _shifts.Clear();
            if (result is not null)
            {
                _shifts.AddRange(result);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnMonthChanged(ChangeEventArgs e)
    {
        var value = Convert.ToString(e.Value, CultureInfo.InvariantCulture);
        if (string.IsNullOrWhiteSpace(value))
        {
            return;
        }

        if (DateTime.TryParseExact(value + "-01", "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var selected))
        {
            _selectedMonth = new DateTime(selected.Year, selected.Month, 1);
            _weekStart = StartOfWeek(_selectedMonth);
            await RefreshShiftsAsync();
        }
    }

    private async Task GoToPreviousWeek()
    {
        _weekStart = _weekStart.AddDays(-7);
        _selectedMonth = new DateTime(_weekStart.Year, _weekStart.Month, 1);
        await RefreshShiftsAsync();
    }

    private async Task GoToNextWeek()
    {
        _weekStart = _weekStart.AddDays(7);
        _selectedMonth = new DateTime(_weekStart.Year, _weekStart.Month, 1);
        await RefreshShiftsAsync();
    }

    private IEnumerable<DateTime> GetWeekDays()
    {
        for (var i = 0; i < 7; i++)
        {
            yield return _weekStart.AddDays(i);
        }
    }

    private string GetWeekRangeLabel()
    {
        var end = _weekStart.AddDays(6);
        if (_weekStart.Month == end.Month)
        {
            return $"{_weekStart:MMMM d} – {end:MMMM d, yyyy}";
        }

        return $"{_weekStart:MMM d} – {end:MMM d, yyyy}";
    }

    private static DateTime StartOfWeek(DateTime date)
    {
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return date.Date.AddDays(-diff);
    }

    private string ResolveEmployeeLabel(Shift shift)
    {
        if (!string.IsNullOrWhiteSpace(_employeeName))
        {
            return _employeeName;
        }

        return string.IsNullOrWhiteSpace(shift.EmployeeName)
            ? "My shift"
            : shift.EmployeeName;
    }
}
