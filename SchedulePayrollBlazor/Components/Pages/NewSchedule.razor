@* @page "/schedules/new" *@
@attribute [Authorize(Roles = "Admin")]
@inject AppDbContext Db
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@using SchedulePayrollBlazor.Data.Models

<div class="ps-page">
    <div class="ps-page-header">
        <div>
            <h2>New schedule</h2>
            <p class="ps-subtitle">Create a shift assignment for an employee.</p>
        </div>
        <div class="ps-page-actions">
            <a class="btn btn-outline-secondary" href="/schedules">Back to schedules</a>
        </div>
    </div>

    @if (employees is null)
    {
        <div class="ps-card">
            <div class="loading">Loadingâ€¦</div>
        </div>
    }
    else if (employees.Count == 0)
    {
        <div class="ps-card">
            <div class="text-muted">Add employees before creating schedules.</div>
        </div>
    }
    else
    {
        <section class="ps-card">
            <div class="ps-card-header">
                <h3>Shift details</h3>
                <p class="ps-subtitle">Select the teammate, date, and working hours.</p>
            </div>
            <EditForm Model="vm"
                      OnValidSubmit="HandleValidSubmit"
                      FormName="NewScheduleForm">
                <DataAnnotationsValidator />
                <ValidationSummary />

                @if (!string.IsNullOrWhiteSpace(vm.FormError))
                {
                    <div class="alert alert-danger" role="alert">@vm.FormError</div>
                }

                <div class="mb-3">
                    <label for="schedule-employee" class="form-label">Employee</label>
                    <select id="schedule-employee" class="form-select" value="@vm.EmployeeId" @onchange="OnEmpChanged">
                        @foreach (var e in employees)
                        {
                            <option value="@e.EmployeeId">@e.FullName (@e.User.Email)</option>
                        }
                    </select>
                </div>

                <div class="row g-3">
                    <div class="col-md-4 col-12">
                        <label for="schedule-date" class="form-label">Date</label>
                        <input id="schedule-date" type="date" class="form-control" value="@vm.ShiftDateText" @onchange="OnDateChanged" />
                    </div>
                    <div class="col-md-4 col-12">
                        <label for="schedule-start" class="form-label">Start time</label>
                        <input id="schedule-start" type="time" class="form-control" value="@vm.StartTimeText" step="60" @onchange="OnStartChanged" />
                    </div>
                    <div class="col-md-4 col-12">
                        <label for="schedule-end" class="form-label">End time</label>
                        <input id="schedule-end" type="time" class="form-control" value="@vm.EndTimeText" step="60" @onchange="OnEndChanged" />
                    </div>
                </div>

                <div class="mb-3 mt-3">
                    <label for="schedule-source" class="form-label">Source</label>
                    <select id="schedule-source" class="form-select" value="@vm.Source" @onchange="OnSourceChanged">
                        <option>Manual</option>
                        <option>Auto</option>
                    </select>
                </div>

                <div class="ps-form-actions">
                    <button class="btn btn-primary" type="submit">Save schedule</button>
                    <a class="btn btn-outline-secondary" href="/schedules">Cancel</a>
                </div>
            </EditForm>
        </section>
    }
</div>

@code {
    private List<Employee>? employees;
    private ScheduleVm vm = new();

    protected override async Task OnInitializedAsync()
    {
        employees = await Db.Employees
            .Include(e => e.User)
            .OrderBy(e => e.User.LastName)
            .ThenBy(e => e.User.FirstName)
            .ToListAsync();

        if (employees.Count > 0 && vm.EmployeeId == 0)
        {
            vm.EmployeeId = employees[0].EmployeeId;
        }
    }

    private Task OnEmpChanged(ChangeEventArgs e)
    {
        if (int.TryParse(Convert.ToString(e.Value, CultureInfo.InvariantCulture), out var id))
        {
            vm.EmployeeId = id;
        }
        return Task.CompletedTask;
    }

    private Task OnDateChanged(ChangeEventArgs e)
    {
        vm.ShiftDateText = Convert.ToString(e.Value, CultureInfo.InvariantCulture) ?? vm.ShiftDateText;
        return Task.CompletedTask;
    }

    private Task OnStartChanged(ChangeEventArgs e)
    {
        vm.StartTimeText = Convert.ToString(e.Value, CultureInfo.InvariantCulture) ?? vm.StartTimeText;
        return Task.CompletedTask;
    }

    private Task OnEndChanged(ChangeEventArgs e)
    {
        vm.EndTimeText = Convert.ToString(e.Value, CultureInfo.InvariantCulture) ?? vm.EndTimeText;
        return Task.CompletedTask;
    }

    private Task OnSourceChanged(ChangeEventArgs e)
    {
        vm.Source = Convert.ToString(e.Value, CultureInfo.InvariantCulture) ?? vm.Source;
        return Task.CompletedTask;
    }

    private async Task HandleValidSubmit()
    {
        vm.FormError = null;

        if (vm.EmployeeId == 0 || employees?.Any(e => e.EmployeeId == vm.EmployeeId) != true)
        {
            vm.FormError = "Select a valid employee.";
            return;
        }

        if (!DateTime.TryParseExact(vm.ShiftDateText, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var date))
        {
            vm.FormError = "Enter a valid shift date.";
            return;
        }

        if (!TimeSpan.TryParseExact(vm.StartTimeText, "hh\\:mm", CultureInfo.InvariantCulture, out var start))
        {
            vm.FormError = "Enter a valid start time.";
            return;
        }

        if (!TimeSpan.TryParseExact(vm.EndTimeText, "hh\\:mm", CultureInfo.InvariantCulture, out var end))
        {
            vm.FormError = "Enter a valid end time.";
            return;
        }

        if (end <= start)
        {
            vm.FormError = "End time must be after start time.";
            return;
        }

        var overlap = await Db.Schedules
            .AnyAsync(s =>
                s.EmployeeId == vm.EmployeeId &&
                s.ShiftDate.Date == date.Date &&
                !(end <= s.StartTime || start >= s.EndTime));

        if (overlap)
        {
            vm.FormError = "Shift overlaps with an existing schedule.";
            return;
        }

        var entity = new Schedule
        {
            EmployeeId = vm.EmployeeId,
            ShiftDate = date,
            StartTime = start,
            EndTime = end,
            Source = vm.Source ?? "Manual"
        };

        await Db.Schedules.AddAsync(entity);
        await Db.SaveChangesAsync();

        Nav.NavigateTo("/schedules", forceLoad: true);
    }

    private class ScheduleVm
    {
        public int EmployeeId { get; set; }
        public string ShiftDateText { get; set; } = DateTime.Today.ToString("yyyy-MM-dd");
        public string StartTimeText { get; set; } = "08:00";
        public string EndTimeText { get; set; } = "17:00";
        public string? Source { get; set; } = "Manual";
        public string? FormError { get; set; }
    }
}
