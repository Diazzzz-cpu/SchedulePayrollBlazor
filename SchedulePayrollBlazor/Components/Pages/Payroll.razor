@page "/payroll"
@attribute [Authorize(Roles = "Admin")]
@inject AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using SchedulePayrollBlazor.Data.Models

<div class="page">
    <header class="page-header">
        <div>
            <h1 class="page-title">Payroll Runs</h1>
            <p class="page-subtitle">Monitor payroll status across pay periods.</p>
        </div>
    </header>

    @if (payPeriods.Count == 0)
    {
        <div class="content-card">
            <div class="alert alert-info">No pay periods found. Create pay period records to begin tracking payroll.</div>
        </div>
    }
    else
    {
        <section class="filter-bar">
            <div class="form-group">
                <label>Pay Period</label>
                <select @onchange="OnPeriodChanged" value="@selectedPeriodId">
                    @foreach (var period in payPeriods)
                    {
                        <option value="@period.PayPeriodId">@period.PeriodName (@period.StartDate:MMM dd â†’ @period.EndDate:MMM dd)</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Runs</label>
                <div class="text-muted">Showing @(filteredRuns.Count) run(s)</div>
            </div>
        </section>

        @if (filteredRuns.Count == 0)
        {
            <div class="content-card">
                <div class="alert alert-warning">No payroll runs found for the selected period.</div>
            </div>
        }
        else
        {
            <section class="content-card">
                <div class="card-header">
                    <h3>Payroll Details</h3>
                    <p>Latest results for the selected pay period.</p>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Gross Pay</th>
                                <th>Deductions</th>
                                <th>Net Pay</th>
                                <th>Status</th>
                                <th>Processed</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var run in filteredRuns)
                            {
                                <tr>
                                    <td>@run.Employee.FullName</td>
                                    <td>$@run.GrossPay.ToString("N2")</td>
                                    <td>$@run.TotalDeductions.ToString("N2")</td>
                                    <td><strong>$@run.NetPay.ToString("N2")</strong></td>
                                    <td><span class="badge @GetStatusClass(run.Status)">@run.Status</span></td>
                                    <td>@run.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>
        }
    }
</div>

@code {
    private List<PayPeriod> payPeriods = new();
    private List<PayrollRun> filteredRuns = new();
    private int selectedPeriodId;

    protected override async Task OnInitializedAsync()
    {
        payPeriods = await Db.PayPeriods
            .OrderByDescending(p => p.StartDate)
            .ToListAsync();

        selectedPeriodId = payPeriods.FirstOrDefault()?.PayPeriodId ?? 0;
        await LoadRunsAsync();
    }

    private async Task OnPeriodChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var periodId))
        {
            selectedPeriodId = periodId;
            await LoadRunsAsync();
        }
    }

    private async Task LoadRunsAsync()
    {
        if (selectedPeriodId == 0)
        {
            filteredRuns = new List<PayrollRun>();
            return;
        }

        filteredRuns = await Db.PayrollRuns
            .Include(r => r.Employee)
                .ThenInclude(e => e.User)
            .Where(r => r.PayPeriodId == selectedPeriodId)
            .OrderByDescending(r => r.CreatedAt)
            .ToListAsync();
    }

    private static string GetStatusClass(string status) => status switch
    {
        "Paid" => "badge-success",
        "Approved" => "badge-info",
        "Calculated" => "badge-warning",
        _ => "badge-secondary"
    };
}
