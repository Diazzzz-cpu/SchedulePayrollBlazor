@page "/payroll"
@attribute [Authorize(Roles = "Admin")]
@inject AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using SchedulePayrollBlazor.Data.Models

<h3>Payroll Runs</h3>

@if (payPeriods.Count == 0)
{
    <div class="alert alert-info">No pay periods found. Create pay period records to begin tracking payroll.</div>
}
else
{
    <div class="d-flex gap-2 align-items-end mb-3">
        <div>
            <label class="form-label">Pay Period</label>
            <select class="form-select" @onchange="OnPeriodChanged" value="@selectedPeriodId">
                @foreach (var period in payPeriods)
                {
                    <option value="@period.Id">@period.PeriodName (@period.StartDate:MMM dd â†’ @period.EndDate:MMM dd)</option>
                }
            </select>
        </div>
        <div class="ms-auto text-muted">
            Showing @(filteredRuns.Count) run(s)
        </div>
    </div>

    @if (filteredRuns.Count == 0)
    {
        <div class="alert alert-warning">No payroll runs found for the selected period.</div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Gross Pay</th>
                    <th>Deductions</th>
                    <th>Net Pay</th>
                    <th>Status</th>
                    <th>Processed</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var run in filteredRuns)
                {
                    <tr>
                        <td>@run.Employee.FullName</td>
                        <td>$@run.GrossPay.ToString("N2")</td>
                        <td>$@run.TotalDeductions.ToString("N2")</td>
                        <td><strong>$@run.NetPay.ToString("N2")</strong></td>
                        <td><span class="badge @GetStatusClass(run.Status)">@run.Status</span></td>
                        <td>@run.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private List<PayPeriod> payPeriods = new();
    private List<PayrollRun> filteredRuns = new();
    private int selectedPeriodId;

    protected override async Task OnInitializedAsync()
    {
        payPeriods = await Db.PayPeriods
            .OrderByDescending(p => p.StartDate)
            .ToListAsync();

        selectedPeriodId = payPeriods.FirstOrDefault()?.Id ?? 0;
        await LoadRunsAsync();
    }

    private async Task OnPeriodChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var periodId))
        {
            selectedPeriodId = periodId;
            await LoadRunsAsync();
        }
    }

    private async Task LoadRunsAsync()
    {
        if (selectedPeriodId == 0)
        {
            filteredRuns = new List<PayrollRun>();
            return;
        }

        filteredRuns = await Db.PayrollRuns
            .Include(r => r.Employee)
                .ThenInclude(e => e.User)
            .Where(r => r.PayPeriodId == selectedPeriodId)
            .OrderByDescending(r => r.CreatedAt)
            .ToListAsync();
    }

    private static string GetStatusClass(string status) => status switch
    {
        "Paid" => "badge-success",
        "Approved" => "badge-info",
        "Calculated" => "badge-warning",
        _ => "badge-secondary"
    };
}
