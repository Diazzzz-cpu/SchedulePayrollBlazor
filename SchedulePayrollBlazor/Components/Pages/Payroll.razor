@page "/payroll"
@attribute [Authorize(Roles = "Admin")]
@inject AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using SchedulePayrollBlazor.Data.Models

<div class="ps-page">
    <div class="ps-page-header">
        <div>
            <h2>PaySync Payroll Center</h2>
            <p class="ps-subtitle">Monitor payroll status across pay periods.</p>
        </div>
    </div>

    @if (payPeriods.Count == 0)
    {
        <div class="ps-card">
            <div class="alert alert-info">No pay periods found. Create pay period records to begin tracking payroll.</div>
        </div>
    }
    else
    {
        <section class="ps-card">
            <div class="ps-card-header">
                <h3>Filter by pay period</h3>
                <p class="ps-subtitle">Focus on the dates that matter.</p>
            </div>
            <div class="filter-bar">
                <div class="form-group">
                    <label>Pay Period</label>
                    <select @onchange="OnPeriodChanged" value="@selectedPeriodId" class="form-select">
                        @foreach (var period in payPeriods)
                        {
                            <option value="@period.PayPeriodId">@period.PeriodName (@period.StartDate:MMM dd â†’ @period.EndDate:MMM dd)</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Runs</label>
                    <div class="text-muted">Showing @(filteredRuns.Count) run(s)</div>
                </div>
            </div>
        </section>

        @if (filteredRuns.Count == 0)
        {
            <div class="ps-card">
                <div class="alert alert-warning">No payroll runs found for the selected period.</div>
            </div>
        }
        else
        {
            <section class="ps-card">
                <div class="ps-card-header">
                    <h3>Payroll details</h3>
                    <p class="ps-subtitle">Latest results for the selected pay period.</p>
                </div>
                <div class="ps-table-container">
                    <table class="ps-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Gross Pay</th>
                                <th>Deductions</th>
                                <th>Net Pay</th>
                                <th data-align="center">Status</th>
                                <th>Processed</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var run in filteredRuns)
                            {
                                <tr>
                                    <td>@run.Employee.FullName</td>
                                    <td>$@run.GrossPay.ToString("N2")</td>
                                    <td>$@run.TotalDeductions.ToString("N2")</td>
                                    <td><strong>$@run.NetPay.ToString("N2")</strong></td>
                                    <td data-align="center"><span class="badge @GetStatusClass(run.Status)">@run.Status</span></td>
                                    <td>@run.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>
        }
    }
</div>

@code {
    private List<PayPeriod> payPeriods = new();
    private List<PayrollRun> filteredRuns = new();
    private int selectedPeriodId;

    protected override async Task OnInitializedAsync()
    {
        payPeriods = await Db.PayPeriods
            .OrderByDescending(p => p.StartDate)
            .ToListAsync();

        selectedPeriodId = payPeriods.FirstOrDefault()?.PayPeriodId ?? 0;
        await LoadRunsAsync();
    }

    private async Task OnPeriodChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var periodId))
        {
            selectedPeriodId = periodId;
            await LoadRunsAsync();
        }
    }

    private async Task LoadRunsAsync()
    {
        if (selectedPeriodId == 0)
        {
            filteredRuns = new List<PayrollRun>();
            return;
        }

        filteredRuns = await Db.PayrollRuns
            .Include(r => r.Employee)
                .ThenInclude(e => e.User)
            .Where(r => r.PayPeriodId == selectedPeriodId)
            .OrderByDescending(r => r.CreatedAt)
            .ToListAsync();
    }

    private static string GetStatusClass(string status) => status switch
    {
        "Paid" => "badge-success",
        "Approved" => "badge-success",
        "Calculated" => "badge-warning",
        "Pending" => "badge-warning",
        "Failed" => "badge-danger",
        _ => "badge-secondary"
    };
}
