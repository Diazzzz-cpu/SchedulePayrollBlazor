@page "/admin/payroll"
@attribute [Authorize(Roles = "Admin")]
@inject AppDbContext Db
@inject IPayrollService PayrollService
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Linq
@using SchedulePayrollBlazor.Data.Models
@using SchedulePayrollBlazor.Utilities

<div class="ps-page">
    <div class="ps-page-header">
        <div>
            <h2>Payroll processing</h2>
            <p class="ps-subtitle">Create periods, generate payroll, and manage adjustments.</p>
        </div>
        <div class="ps-page-actions">
            <button class="btn btn-outline-primary" @onclick="() => showCreatePeriod = !showCreatePeriod">
                @(showCreatePeriod ? "Close" : "New period")
            </button>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(alertMessage))
    {
        <div class="ps-alert @(alertIsError ? "ps-alert-danger" : "ps-alert-success")" role="status">
            <div>@alertMessage</div>
            <button type="button"
                    class="ps-alert-close"
                    @onclick="() => alertMessage = string.Empty"
                    aria-label="Dismiss message">
                &times;
            </button>
        </div>
    }

    @if (showCreatePeriod)
    {
        <section class="ps-card">
            <div class="ps-card-header">
                <h3>Create payroll period</h3>
                <p class="ps-subtitle">Define the date range that will be used when calculating shifts.</p>
            </div>
            <EditForm Model="createModel" OnValidSubmit="CreatePeriodAsync">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="ps-form-grid">
                    <div class="form-group">
                        <label for="period-name">Name</label>
                        <InputText id="period-name" class="form-control" @bind-Value="createModel.Name" />
                        <ValidationMessage For="() => createModel.Name" />
                    </div>
                    <div class="form-group">
                        <label for="period-start">Start date</label>
                        <InputDate id="period-start" class="form-control" @bind-Value="createModel.StartDate" />
                        <ValidationMessage For="() => createModel.StartDate" />
                    </div>
                    <div class="form-group">
                        <label for="period-end">End date</label>
                        <InputDate id="period-end" class="form-control" @bind-Value="createModel.EndDate" />
                        <ValidationMessage For="() => createModel.EndDate" />
                    </div>
                </div>

                <div class="ps-form-actions">
                    <button type="submit" class="btn btn-primary">Create period</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => showCreatePeriod = false">Cancel</button>
                </div>
            </EditForm>
        </section>
    }

    <section class="ps-card">
        <div class="ps-card-header">
            <h3>Payroll periods</h3>
            <p class="ps-subtitle">Select a period to view generated payroll entries.</p>
        </div>
        <div class="ps-form-grid">
            <div class="form-group">
                <label for="period-select">Select period</label>
                <select id="period-select"
                        class="form-select"
                        @onchange="OnPeriodChanged"
                        value="@selectedPeriodId">
                    <option value="0">-- Choose a period --</option>
                    @foreach (var period in periods)
                    {
                        <option value="@period.Id">
                            @GetPeriodOptionLabel(period)
                        </option>
                    }
                </select>
            </div>
            <div class="form-group align-self-end">
                <button class="btn btn-primary"
                        @onclick="GeneratePayrollAsync"
                        disabled="@(selectedPeriodId == 0)">
                    Generate payroll
                </button>
            </div>
        </div>
    </section>

    @if (selectedPeriodId == 0)
    {
        <div class="ps-card">
            <div class="text-muted">Choose a payroll period to see calculated entries.</div>
        </div>
    }
    else if (entries is null)
    {
        <div class="ps-card">
            <div class="loading">Loading…</div>
        </div>
    }
    else if (entries.Count == 0)
    {
        <div class="ps-card">
            <div class="text-muted">
                No payroll entries generated for this period yet. Click “Generate payroll” to calculate salaries.
            </div>
        </div>
    }
    else
    {
        <section class="ps-card payroll-summary-card">
            <div class="ps-card-header">
                <div>
                    <h3>Payroll summary</h3>
                    <p class="ps-subtitle payroll-summary-lede">
                        Base pay is derived from shift hours and compensation settings. Adjustments update the totals instantly.
                    </p>
                </div>
            </div>

            @{
                var fixedEntries = entries
                .Where(e => GetPayStructure(e) == PayStructureType.Fixed)
                .ToList();

                var hybridEntries = entries
                .Where(e => GetPayStructure(e) == PayStructureType.Hybrid)
                .ToList();

                var hourlyEntries = entries
                .Where(e =>
                {
                    var structure = GetPayStructure(e);
                    return structure == PayStructureType.Hourly || structure == PayStructureType.Unknown;
                })
                .ToList();

                var groupedEntries = new List<(string Title, PayStructureType Type, List<PayrollEntry> Items)>
                {
                ("Hourly payroll", PayStructureType.Hourly, hourlyEntries),
                ("Hybrid payroll", PayStructureType.Hybrid, hybridEntries),
                ("Fixed payroll", PayStructureType.Fixed, fixedEntries)
                };
            }

            <div class="payroll-summary-grid">
                @foreach (var group in groupedEntries)
                {
                    <div class="payroll-section-card">
                        <div class="payroll-section-header">
                            <h4 class="payroll-section-title">@group.Title</h4>

                            @if (group.Type == PayStructureType.Fixed && group.Items.Count > 0)
                            {
                                <button type="button"
                                        class="btn btn-outline-primary btn-sm ps-adjust-btn"
                                        @onclick="() => ApplyFixedComponentsAsync(applyToFixed: true, applyToHybrid: false)">
                                    Add pay
                                </button>
                            }
                            else if (group.Type == PayStructureType.Hybrid && group.Items.Count > 0)
                            {
                                <button type="button"
                                        class="btn btn-outline-primary btn-sm ps-adjust-btn"
                                        @onclick="() => ApplyFixedComponentsAsync(applyToFixed: false, applyToHybrid: true)">
                                    Add pay
                                </button>
                            }
                        </div>

                        @if (group.Items.Count == 0)
                        {
                            <div class="text-muted">No entries available.</div>
                        }
                        else
                        {
                            <div class="ps-table-container">
                                <table class="ps-table payroll-table">
                                    <thead>
                                        <tr>
                                            <th class="ps-col-employee">Employee</th>
                                            <th class="ps-col-hours">Hours</th>
                                            <th class="ps-col-base">Base</th>
                                            <th class="ps-col-deductions">Deduct.</th>
                                            <th class="ps-col-bonuses">Bonus</th>
                                            <th class="ps-col-net">Net</th>
                                            <th class="ps-col-updated">Updated</th>
                                            <th class="ps-col-adjust">Adjust</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var entry in group.Items)
                                        {
                                            var form = GetAdjustmentForm(entry.Id);
                                            <tr>
                                                <td class="ps-col-employee">
                                                    <div class="fw-semibold">@GetEmployeeName(entry)</div>
                                                    <div class="text-muted">@GetEmployeeEmail(entry)</div>
                                                </td>
                                                <td class="ps-col-hours">
                                                    @string.Format("{0:N2} hrs", entry.TotalHoursWorked)
                                                </td>
                                                <td class="ps-col-base">
                                                    <strong>@FormatCurrency(entry, entry.BasePay, isBasePay: true)</strong>
                                                </td>
                                                <td class="ps-col-deductions text-danger">
                                                    @FormatCurrency(entry, entry.TotalDeductions)
                                                </td>
                                                <td class="ps-col-bonuses text-success">
                                                    @FormatCurrency(entry, entry.TotalBonuses)
                                                </td>
                                                <td class="ps-col-net">
                                                    <strong>@FormatCurrency(entry, entry.NetPay)</strong>
                                                </td>
                                                <td class="ps-col-updated">
                                                    <div class="payroll-processed">
                                                        <div class="payroll-processed-date">
                                                            @entry.CalculatedAt.ToString("MMM dd, yyyy")
                                                        </div>
                                                        <div class="payroll-processed-time">
                                                            @entry.CalculatedAt.ToString("HH:mm")
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="ps-col-adjust">
                                                    <button type="button"
                                                            class="btn btn-outline-primary btn-sm ps-adjust-btn"
                                                            @onclick="() => ToggleAdjustmentForm(entry.Id)">
                                                        @(adjustingEntryId == entry.Id ? "Close" : "Adjust")
                                                    </button>
                                                    @if ((entry.PayrollLines?.Count ?? 0) > 0)
                                                    {
                                                        <div class="payroll-adjust-summary">
                                                            @entry.PayrollLines.Count line@(entry.PayrollLines.Count == 1 ? string.Empty : "s")
                                                        </div>
                                                    }
                                                </td>
                                            </tr>

                                            @if (adjustingEntryId == entry.Id)
                                            {
                                                var earningLines = GetEarningLines(entry).ToList();
                                                var deductionLines = GetDeductionLines(entry).ToList();
                                                var totalEarnings = earningLines.Sum(l => l.Amount);
                                                var totalDeductions = deductionLines.Sum(l => l.Amount);
                                                <tr class="ps-table-row-detail">
                                                    <td colspan="8">
                                                        <div class="payroll-adjustments">
                                                            <div class="payroll-adjustments-header">
                                                                <h4>Payroll breakdown</h4>
                                                                <div class="text-muted small">
                                                                    @GetPeriodName(entry) — @GetPeriodRange(entry)
                                                                </div>
                                                            </div>

                                                            <div class="payroll-lines-grid">
                                                                <div class="payroll-lines-section">
                                                                    <h5 class="payroll-lines-title">Earnings</h5>
                                                                    @if (earningLines.Count == 0)
                                                                    {
                                                                        <div class="text-muted">No earnings recorded.</div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <table class="ps-table ps-table-compact">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Code</th>
                                                                                    <th>Description</th>
                                                                                    <th>Quantity</th>
                                                                                    <th>Rate</th>
                                                                                    <th class="text-end">Amount</th>
                                                                                    <th></th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                @foreach (var line in earningLines)
                                                                                {
                                                                                    <tr>
                                                                                        <td><span class="ps-badge">@line.Code</span></td>
                                                                                        <td>@line.Description</td>
                                                                                        <td>@FormatQuantity(line)</td>
                                                                                        <td>@FormatRate(line)</td>
                                                                                        <td class="text-end">@FormatAmount(line.Amount)</td>
                                                                                        <td class="text-end">
                                                                                            @if (!line.IsAutoGenerated)
                                                                                            {
                                                                                                <button type="button"
                                                                                                        class="ps-button ps-button-ghost"
                                                                                                        @onclick="() => RemoveAdjustmentAsync(line.PayrollLineId)">
                                                                                                    Remove
                                                                                                </button>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <span class="badge bg-secondary">Auto</span>
                                                                                            }
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    }
                                                                </div>

                                                                <div class="payroll-lines-section">
                                                                    <h5 class="payroll-lines-title">Deductions</h5>
                                                                    @if (deductionLines.Count == 0)
                                                                    {
                                                                        <div class="text-muted">No deductions recorded.</div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <table class="ps-table ps-table-compact">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Code</th>
                                                                                    <th>Description</th>
                                                                                    <th>Quantity</th>
                                                                                    <th>Rate</th>
                                                                                    <th class="text-end">Amount</th>
                                                                                    <th></th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                @foreach (var line in deductionLines)
                                                                                {
                                                                                    <tr>
                                                                                        <td><span class="ps-badge">@line.Code</span></td>
                                                                                        <td>@line.Description</td>
                                                                                        <td>@FormatQuantity(line)</td>
                                                                                        <td>@FormatRate(line)</td>
                                                                                        <td class="text-end">@FormatAmount(line.Amount)</td>
                                                                                        <td class="text-end">
                                                                                            @if (!line.IsAutoGenerated)
                                                                                            {
                                                                                                <button type="button"
                                                                                                        class="ps-button ps-button-ghost"
                                                                                                        @onclick="() => RemoveAdjustmentAsync(line.PayrollLineId)">
                                                                                                    Remove
                                                                                                </button>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <span class="badge bg-secondary">Auto</span>
                                                                                            }
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    }
                                                                </div>
                                                            </div>

                                                            <div class="payroll-breakdown-summary">
                                                                <div>Subtotal earnings: <strong>@FormatAmount(totalEarnings)</strong></div>
                                                                <div>Subtotal deductions: <strong class="text-danger">@FormatAmount(totalDeductions)</strong></div>
                                                                <div>Net pay: <strong>@FormatAmount(totalEarnings - totalDeductions)</strong></div>
                                                            </div>

                                                            <div class="payroll-adjustments-form">
                                                                <h4 class="payroll-adjust-title">Add manual line</h4>
                                                                <EditForm Model="form"
                                                                          OnValidSubmit="async () => await AddAdjustmentAsync(entry.Id)">
                                                                    <DataAnnotationsValidator />
                                                                    <ValidationSummary />

                                                                    <div class="payroll-adjust-inline-fields">
                                                                        <div class="form-group">
                                                                            <label for="@($"label-{entry.Id}")">Label</label>
                                                                            <InputText id="@($"label-{entry.Id}")"
                                                                                       class="form-control"
                                                                                       @bind-Value="form.Label" />
                                                                            <ValidationMessage For="() => form.Label" />
                                                                        </div>

                                                                        <div class="form-group payroll-adjust-type">
                                                                            <label for="@($"type-{entry.Id}")">Type</label>
                                                                            <InputSelect id="@($"type-{entry.Id}")"
                                                                                         class="form-select"
                                                                                         @bind-Value="form.Type">
                                                                                <option value="Deduction">Deduction</option>
                                                                                <option value="Bonus">Bonus</option>
                                                                            </InputSelect>
                                                                        </div>

                                                                        <div class="form-group">
                                                                            <label for="@($"amount-{entry.Id}")">Amount (PHP)</label>
                                                                            <InputNumber id="@($"amount-{entry.Id}")"
                                                                                         class="form-control"
                                                                                         @bind-Value="form.Amount"
                                                                                         step="0.01" />
                                                                            <ValidationMessage For="() => form.Amount" />
                                                                        </div>

                                                                        <div class="payroll-adjust-inline-actions">
                                                                            <button type="submit" class="btn btn-primary btn-sm">
                                                                                Add
                                                                            </button>
                                                                            <button type="button"
                                                                                    class="btn btn-outline-secondary btn-sm"
                                                                                    @onclick="() => CloseAdjustmentForm(entry.Id)">
                                                                                Cancel
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </EditForm>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }
            </div>
        </section>
    }
</div>

@code {
    private readonly Dictionary<int, AdjustmentFormModel> adjustmentForms = new();
    private int? adjustingEntryId;
    private List<PayrollPeriod> periods = new();
    private List<PayrollEntry>? entries;
    private bool showCreatePeriod;
    private int selectedPeriodId;
    private string? alertMessage;
    private bool alertIsError;

    private readonly CreatePeriodModel createModel = new()
    {
        StartDate = DateTime.Today,
        EndDate = DateTime.Today
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            periods = await Db.PayrollPeriods
                .OrderByDescending(p => p.StartDate)
                .ThenByDescending(p => p.Id)
                .ToListAsync();

            if (periods.Count > 0)
            {
                selectedPeriodId = periods.First().Id;
                await LoadEntriesAsync();
            }
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Error loading payroll data: {ex.Message}";
            periods = new List<PayrollPeriod>();
            entries = new List<PayrollEntry>();
        }
    }

    private async Task CreatePeriodAsync()
    {
        try
        {
            var period = await PayrollService.CreatePayrollPeriodAsync(
                createModel.Name ?? string.Empty,
                createModel.StartDate,
                createModel.EndDate);

            periods.Insert(0, period);
            selectedPeriodId = period.Id;
            showCreatePeriod = false;
            createModel.Reset();

            alertIsError = false;
            alertMessage = $"Created payroll period '{period.Name}'.";

            await LoadEntriesAsync();
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Error creating payroll period: {ex.Message}";
        }
    }

    private async Task GeneratePayrollAsync()
    {
        if (selectedPeriodId == 0)
        {
            return;
        }

        try
        {
            entries = await PayrollService.GeneratePayrollForPeriodAsync(selectedPeriodId);
            EnsureAdjustmentForms();
            adjustingEntryId = null;
            alertIsError = false;
            alertMessage = "Payroll recalculated successfully.";
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Error generating payroll: {ex.Message}";
            entries ??= new List<PayrollEntry>();
        }
    }

    private async Task LoadEntriesAsync()
    {
        if (selectedPeriodId == 0)
        {
            entries = null;
            return;
        }

        try
        {
            entries = await PayrollService.GetPayrollEntriesForPeriodAsync(selectedPeriodId);
            EnsureAdjustmentForms();
            adjustingEntryId = null;
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Error loading payroll entries: {ex.Message}";
            entries = new List<PayrollEntry>();
        }
    }

    private void ToggleAdjustmentForm(int entryId)
    {
        EnsureAdjustmentForms();
        adjustingEntryId = adjustingEntryId == entryId ? null : entryId;
    }

    private void CloseAdjustmentForm(int entryId)
    {
        if (adjustingEntryId == entryId)
        {
            adjustingEntryId = null;
        }
    }

    private async Task AddAdjustmentAsync(int entryId)
    {
        var form = GetAdjustmentForm(entryId);

        try
        {
            await PayrollService.AddAdjustmentAsync(entryId, form.Type, form.Label, form.Amount);
            adjustmentForms[entryId] = new AdjustmentFormModel { Type = form.Type };
            await LoadEntriesAsync();

            alertIsError = false;
            alertMessage = "Adjustment added.";
            adjustingEntryId = null;
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Error adding adjustment: {ex.Message}";
        }
    }

    private async Task RemoveAdjustmentAsync(int adjustmentId)
    {
        try
        {
            await PayrollService.RemoveAdjustmentAsync(adjustmentId);
            await LoadEntriesAsync();

            alertIsError = false;
            alertMessage = "Adjustment removed.";
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Error removing adjustment: {ex.Message}";
        }
    }

    private async Task OnPeriodChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var id))
        {
            selectedPeriodId = id;
            entries = null;
            await LoadEntriesAsync();
        }
    }

    private async Task ApplyFixedComponentsAsync(bool applyToFixed, bool applyToHybrid)
    {
        if (selectedPeriodId == 0)
        {
            return;
        }

        try
        {
            entries = await PayrollService.ApplyFixedPayAsync(selectedPeriodId, applyToFixed, applyToHybrid);
            EnsureAdjustmentForms();
            adjustingEntryId = null;
            alertIsError = false;
            alertMessage = applyToFixed && applyToHybrid
                ? "Fixed pay applied for eligible employees."
                : applyToFixed
                    ? "Fixed salaries added."
                    : "Hybrid fixed pay added.";
        }
        catch (Exception ex)
        {
            alertIsError = true;
            alertMessage = $"Error applying fixed pay: {ex.Message}";
        }
    }

    private AdjustmentFormModel GetAdjustmentForm(int entryId)
    {
        if (!adjustmentForms.TryGetValue(entryId, out var model) || model is null)
        {
            model = new AdjustmentFormModel();
            adjustmentForms[entryId] = model;
        }

        return model;
    }

    private static string GetEmployeeName(PayrollEntry entry)
        => entry.Employee?.FullName ?? "Unknown employee";

    private static string GetEmployeeEmail(PayrollEntry entry)
        => entry.Employee?.User?.Email ?? "-";

    private static string GetPeriodName(PayrollEntry entry)
        => entry.PayrollPeriod?.Name ?? "Payroll period";

    private static string GetPeriodRange(PayrollEntry entry)
        => entry.PayrollPeriod is null
            ? "—"
            : $"{entry.PayrollPeriod.StartDate:MMM dd, yyyy} – {entry.PayrollPeriod.EndDate:MMM dd, yyyy}";

    private static string GetPeriodOptionLabel(PayrollPeriod? period)
    {
        if (period is null)
        {
            return "Payroll period";
        }

        var name = string.IsNullOrWhiteSpace(period.Name) ? "Payroll period" : period.Name;
        return $"{name} ({period.StartDate:MMM dd, yyyy} – {period.EndDate:MMM dd, yyyy})";
    }

    private void EnsureAdjustmentForms()
    {
        if (entries is null)
        {
            return;
        }

        foreach (var entry in entries)
        {
            if (!adjustmentForms.ContainsKey(entry.Id))
            {
                adjustmentForms[entry.Id] = new AdjustmentFormModel();
            }
        }
    }

    private static PayStructureType GetPayStructure(PayrollEntry entry)
    {
        return PayStructureHelper.Determine(entry.Employee?.Compensation);
    }

    private static IEnumerable<PayrollLine> GetEarningLines(PayrollEntry entry)
        => entry.PayrollLines?.Where(l => string.Equals(l.Kind, "Earning", StringComparison.OrdinalIgnoreCase))
        ?? Enumerable.Empty<PayrollLine>();

    private static IEnumerable<PayrollLine> GetDeductionLines(PayrollEntry entry)
        => entry.PayrollLines?.Where(l => string.Equals(l.Kind, "Deduction", StringComparison.OrdinalIgnoreCase))
        ?? Enumerable.Empty<PayrollLine>();

    private string FormatAmount(decimal amount) => $"₱{amount:N2}";

    private string FormatQuantity(PayrollLine line)
    {
        var code = line.Code.ToUpperInvariant();

        if (code == "LATE" || code == "UNDERTIME" || code == "OT")
        {
            return $"{line.Quantity:N2} mins";
        }

        if (code == "ABSENCE" || code == "BASE")
        {
            return $"{line.Quantity:N2} hrs";
        }

        return line.Quantity == 0 ? "—" : line.Quantity.ToString("N2");
    }

    private string FormatRate(PayrollLine line)
    {
        if (line.Rate == 0)
        {
            return "—";
        }

        var calculationType = line.PayComponent?.CalculationType ?? string.Empty;
        if (string.Equals(calculationType, "PercentageOfBase", StringComparison.OrdinalIgnoreCase) && line.Rate <= 1)
        {
            return line.Rate.ToString("P2");
        }

        return FormatAmount(line.Rate);
    }

    private string FormatCurrency(PayrollEntry entry, decimal amount, bool isBasePay = false)
    {
        var structure = GetPayStructure(entry);

        if (structure == PayStructureType.Fixed && entry.BasePay == 0m && (isBasePay || amount == 0m))
        {
            return "—";
        }

        return $"₱{amount:N2}";
    }

    private sealed class CreatePeriodModel : IValidatableObject
    {
        [Required]
        [StringLength(150, MinimumLength = 3)]
        public string? Name { get; set; }

        [Required]
        public DateTime StartDate { get; set; }

        [Required]
        public DateTime EndDate { get; set; }

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (EndDate < StartDate)
            {
                yield return new ValidationResult("End date cannot be earlier than start date.", new[] { nameof(EndDate) });
            }
        }

        public void Reset()
        {
            Name = string.Empty;
            StartDate = DateTime.Today;
            EndDate = DateTime.Today;
        }
    }

    private sealed class AdjustmentFormModel : IValidatableObject
    {
        public string Type { get; set; } = "Deduction";

        [Required]
        [StringLength(150)]
        public string Label { get; set; } = string.Empty;

        [Required]
        public decimal Amount { get; set; } = 0.01m;

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (!string.Equals(Type, "Deduction", StringComparison.OrdinalIgnoreCase) &&
                !string.Equals(Type, "Bonus", StringComparison.OrdinalIgnoreCase))
            {
                yield return new ValidationResult("Type must be either Deduction or Bonus.", new[] { nameof(Type) });
            }

            if (Amount <= 0)
            {
                yield return new ValidationResult("Amount must be greater than 0.", new[] { nameof(Amount) });
            }
        }
    }
}
