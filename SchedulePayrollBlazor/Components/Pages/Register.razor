@page "/register"
@inject AuthService AuthService
@inject NavigationManager Nav
@using SchedulePayrollBlazor.Data.Models

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h2>Create Account</h2>
            <p>Join SchedulePayroll to manage your work schedule</p>
        </div>

        <EditForm Model="@model" OnValidSubmit="HandleRegister" FormName="RegisterForm">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label>Full Name</label>
                <InputText @bind-Value="model.Name" class="form-control" placeholder="John Doe" />
                <ValidationMessage For="@(() => model.Name)" />
            </div>

            <div class="form-group">
                <label>Email Address</label>
                <InputText @bind-Value="model.Email" class="form-control" type="email" placeholder="john@example.com" />
                <ValidationMessage For="@(() => model.Email)" />
            </div>

            <div class="form-group">
                <label>Password</label>
                <InputText @bind-Value="model.Password" class="form-control" type="password" placeholder="••••••••" />
                <ValidationMessage For="@(() => model.Password)" />
            </div>

            <div class="form-group">
                <label>Confirm Password</label>
                <InputText @bind-Value="model.ConfirmPassword" class="form-control" type="password" placeholder="••••••••" />
                <ValidationMessage For="@(() => model.ConfirmPassword)" />
            </div>

            <div class="form-group">
                <label>Role</label>
                <InputSelect @bind-Value="model.RoleId" class="form-control">
                    <option value="0">-- Select Role --</option>
                    @foreach (var role in roles)
                    {
                        <option value="@role.RoleId">@role.Name</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => model.RoleId)" />
            </div>

            <div class="form-group">
                <label>Employment Type</label>
                <InputSelect @bind-Value="model.EmploymentType" class="form-control">
                    <option value="Hourly">Hourly</option>
                    <option value="Salaried">Salaried</option>
                </InputSelect>
            </div>

            @if (model.EmploymentType == "Hourly")
            {
                <div class="form-group">
                    <label>Hourly Rate ($)</label>
                    <InputNumber @bind-Value="model.HourlyRate" class="form-control" />
                </div>
            }
            else
            {
                <div class="form-group">
                    <label>Monthly Salary ($)</label>
                    <InputNumber @bind-Value="model.MonthlyRate" class="form-control" />
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            @if (!string.IsNullOrWhiteSpace(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            <button type="submit" class="btn btn-primary btn-block" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>Creating Account...</span>
                }
                else
                {
                    <span>Create Account</span>
                }
            </button>
        </EditForm>

        <div class="auth-footer">
            <p>Already have an account? <a href="/login">Sign in</a></p>
        </div>
    </div>
</div>

@code {
    private RegisterModel model = new();
    private List<Role> roles = new();
    private string errorMessage = "";
    private string successMessage = "";
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        roles = await AuthService.GetRolesAsync();
    }

    private async Task HandleRegister()
    {
        errorMessage = "";
        successMessage = "";
        isLoading = true;

        if (model.Password != model.ConfirmPassword)
        {
            errorMessage = "Passwords do not match.";
            isLoading = false;
            return;
        }

        if (model.RoleId == 0)
        {
            errorMessage = "Please select a role.";
            isLoading = false;
            return;
        }

        var (success, message) = await AuthService.RegisterAsync(
            model.Name,
            model.Email,
            model.Password,
            model.RoleId,
            model.EmploymentClass,
            model.EmploymentType,
            model.HourlyRate,
            model.MonthlyRate
        );

        isLoading = false;

        if (success)
        {
            successMessage = message;
            await Task.Delay(1500);
            Nav.NavigateTo("/login");
        }
        else
        {
            errorMessage = message;
        }
    }

    public class RegisterModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
        public int RoleId { get; set; }
        public string EmploymentClass { get; set; } = "FullTime";
        public string EmploymentType { get; set; } = "Hourly";
        public decimal HourlyRate { get; set; } = 15.00m;
        public decimal MonthlyRate { get; set; } = 0m;
    }
}
