@page "/schedules"
@attribute [Authorize]
@using System
@using System.Globalization
@using System.Linq
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@inject IShiftService ShiftService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject AppDbContext Db

<div class="ps-schedule-page">
    <div class="ps-schedule-header-bar">
        <div class="ps-schedule-heading">
            <h1 class="ps-schedule-title">Shift schedule</h1>
            <p class="ps-schedule-subtitle">Plan coverage and keep every team informed.</p>
        </div>
        <div class="ps-schedule-actions">
            @* Removed UTC badge per instructions *@
            <AuthorizeView Roles="Admin">
                <Authorized>
                    <button type="button" class="ps-button ps-button-primary" @onclick="CreateShift">
                        Create shift(s)
                    </button>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>

    <div class="ps-tabs" role="tablist">
        <button type="button" class="ps-tab ps-tab-active" aria-current="page">Shift schedule</button>
        <button type="button" class="ps-tab" @onclick="@(() => Nav.NavigateTo("/schedules/history"))">Shift history</button>
    </div>

    <div class="ps-filter-row">
        <div class="ps-filter-group">
            <div class="ps-filter-field">
                <span class="ps-filter-label">Employee group:</span>
                <InputSelect @bind-Value="SelectedGroup" class="ps-filter-control" disabled="@(!_isAdmin)">
                    <option value="">Group</option>
                    @foreach (var group in _groups)
                    {
                        <option value="@group">@group</option>
                    }
                </InputSelect>
            </div>
            <div class="ps-filter-field">
                <span class="ps-filter-label">Employee:</span>
                @{ var employees = FilteredEmployees.ToList(); }
                <InputSelect @bind-Value="_selectedEmployeeId" class="ps-filter-control" disabled="@(!_isAdmin && _currentEmployeeId.HasValue)">
                    <option value="">Employee</option>
                    @foreach (var employee in employees)
                    {
                        <option value="@employee.Id">@employee.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="ps-filter-field">
                <span class="ps-filter-label">Date:</span>
                <input type="month" class="ps-filter-control" value="@MonthInputValue" @onchange="OnMonthChanged" />
            </div>
        </div>
        <div class="ps-filter-actions">
            <div class="ps-filter-field ps-filter-search">
                <span class="ps-filter-label">Search:</span>
                <InputText class="ps-filter-control" placeholder="Search by name or note" @bind-Value="_searchText" />
            </div>
            <div class="ps-filter-buttons">
                <button type="button" class="ps-button ps-button-ghost" @onclick="OnReset">Reset</button>
                <button type="button" class="ps-button ps-button-primary" @onclick="OnSearchAsync" disabled="@_isLoadingShifts">Search</button>
            </div>
        </div>
    </div>

    @* Removed DST warning per instructions *@

    <div class="ps-schedule-card">
        <div class="ps-schedule-header">
            <div class="ps-schedule-nav-buttons">
                <button type="button" class="ps-button ps-button-ghost ps-icon-button" @onclick="GoToPreviousWeek" disabled="@_isLoadingShifts" aria-label="Previous week">
                    ‹
                </button>
            </div>
            <div class="ps-schedule-week-label">@GetWeekRangeLabel()</div>
            <div class="ps-schedule-nav-buttons">
                <button type="button" class="ps-button ps-button-ghost ps-icon-button" @onclick="GoToNextWeek" disabled="@_isLoadingShifts" aria-label="Next week">
                    ›
                </button>
            </div>
        </div>

        @if (_isLoadingShifts && !_shifts.Any())
        {
            <div class="ps-schedule-loading">Loading shifts...</div>
        }

        <div class="ps-schedule-grid">
            @foreach (var day in GetWeekDays())
            {
                var dayShifts = _shifts
                    .Where(s => s.Start.Date == day.Date)
                    .OrderBy(s => s.Start)
                    .ToList();

                <div class="ps-schedule-column">
                    <div class="ps-schedule-column-header">
                        <div class="ps-schedule-day-name">@day.ToString("ddd", CultureInfo.InvariantCulture)</div>
                        <div class="ps-schedule-day-date">@day.ToString("dd", CultureInfo.InvariantCulture)</div>
                    </div>
                    <div class="ps-schedule-column-body">
                        @if (dayShifts.Count == 0)
                        {
                            <div class="ps-schedule-empty">No shifts</div>
                        }
                        else
                        {
                            @* Removed hardcoded shifts; data now fully driven by _shifts *@
                            @foreach (var shift in dayShifts)
                            {
                                <div class="ps-shift-card @(_isAdmin ? "ps-shift-card-action" : string.Empty)" @onclick="(() => OnShiftSelected(shift))">
                                    <div class="ps-shift-accent"></div>
                                    <div class="ps-shift-body">
                                        <div class="ps-shift-employee">@shift.EmployeeName</div>
                                        <div class="ps-shift-time">@shift.Start.ToString("hh:mm tt", CultureInfo.InvariantCulture) – @shift.End.ToString("hh:mm tt", CultureInfo.InvariantCulture)</div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    @if (_isAdmin)
    {
        <ShiftModal
            IsOpen="_isModalOpen"
            IsOpenChanged="OnModalOpenChanged"
            Model="_editingShift"
            Employees="_employees.Select(e => (e.Id, e.Name)).ToList()"
            Title="@(_isNewShift ? "Create shift" : "Edit shift")"
            OnSave="OnModalSave"
            OnCancel="OnModalCancel"
            OnDelete="OnModalDelete"
            ErrorMessage="@_modalError"
            IsBusy="_isModalBusy" />
    }
</div>

@code {
    private bool _isAdmin;
    private bool _isLoadingShifts;
    private DateTime _weekStart;
    private DateTime _selectedMonth;
    private readonly List<Shift> _shifts = new();
    private string? _selectedGroup = "All";
    private int? _selectedEmployeeId;
    private string? _searchText;
    private int? _currentEmployeeId;
    private List<string> _groups = new() { "All" };
    private List<(int Id, string Name, string Group)> _employees = new();
    private bool _isModalOpen;
    private bool _isNewShift;
    private Shift? _editingShift;
    private string? _modalError;
    private bool _isModalBusy;

    private string? SelectedGroup
    {
        get => _selectedGroup;
        set
        {
            if (_selectedGroup == value)
            {
                return;
            }

            _selectedGroup = value;
            EnsureEmployeeWithinGroup();
        }
    }

    private string MonthInputValue => _selectedMonth.ToString("yyyy-MM", CultureInfo.InvariantCulture);

    private IEnumerable<(int Id, string Name, string Group)> FilteredEmployees =>
        string.IsNullOrWhiteSpace(_selectedGroup) || _selectedGroup == "All"
            ? _employees
            : _employees.Where(e => string.Equals(e.Group, _selectedGroup, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var today = DateTime.Today;
        _weekStart = StartOfWeek(today);
        _selectedMonth = new DateTime(today.Year, today.Month, 1);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAdmin = user.IsInRole("Admin");

        var employeeIdClaim = user.FindFirst("EmployeeId")?.Value;
        if (int.TryParse(employeeIdClaim, out var employeeId))
        {
            _currentEmployeeId = employeeId;
        }

        if (!_isAdmin && _currentEmployeeId.HasValue)
        {
            _selectedEmployeeId = _currentEmployeeId;
        }

        await LoadEmployeesAsync();
        await LoadShiftsAsync();
    }

    private async Task LoadEmployeesAsync()
    {
        List<(int Id, string Name, string Group)> employees;

        try
        {
            var records = await Db.Employees
                .AsNoTracking()
                .OrderBy(e => e.FullName)
                .Select(e => new { e.EmployeeId, e.FullName, e.Department })
                .ToListAsync();

            employees = records
                .Select(e => (e.EmployeeId,
                    string.IsNullOrWhiteSpace(e.FullName) ? $"Employee {e.EmployeeId}" : e.FullName!,
                    string.IsNullOrWhiteSpace(e.Department) ? string.Empty : e.Department!))
                .ToList();
        }
        catch
        {
            employees = new();
        }

        if (!_isAdmin && _currentEmployeeId.HasValue)
        {
            var self = employees.FirstOrDefault(e => e.Id == _currentEmployeeId.Value);
            if (self != default)
            {
                _employees = new List<(int, string, string)> { self };
                _selectedEmployeeId = self.Id;
                SelectedGroup = string.IsNullOrWhiteSpace(self.Group) ? null : self.Group;
                _groups = string.IsNullOrWhiteSpace(self.Group)
                    ? new List<string>()
                    : new List<string> { self.Group };
            }
            else
            {
                _employees = new();
                _selectedEmployeeId = null;
                SelectedGroup = null;
                _groups = new List<string>();
            }

            return;
        }

        _employees = employees;

        var groupSet = new SortedSet<string>(StringComparer.OrdinalIgnoreCase) { "All" };
        foreach (var employee in _employees)
        {
            if (!string.IsNullOrWhiteSpace(employee.Group))
            {
                groupSet.Add(employee.Group);
            }
        }

        _groups = groupSet
            .OrderBy(g => string.Equals(g, "All", StringComparison.OrdinalIgnoreCase) ? 0 : 1)
            .ThenBy(g => g, StringComparer.OrdinalIgnoreCase)
            .ToList();

        if (_isAdmin)
        {
            SelectedGroup = _selectedGroup ?? "All";
        }
        else
        {
            SelectedGroup = _groups.FirstOrDefault(g => !string.Equals(g, "All", StringComparison.OrdinalIgnoreCase));
        }

        if (!_isAdmin)
        {
            _selectedEmployeeId = null;
        }
    }

    private async Task LoadShiftsAsync()
    {
        _isLoadingShifts = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var weekEnd = _weekStart.AddDays(7);
            var employeeFilter = _isAdmin ? _selectedEmployeeId : _currentEmployeeId;
            var groupFilter = string.Equals(_selectedGroup, "All", StringComparison.OrdinalIgnoreCase)
                ? null
                : _selectedGroup;

            var result = await ShiftService.GetShiftsAsync(
                _weekStart,
                weekEnd,
                employeeFilter,
                groupFilter,
                _searchText);

            _shifts.Clear();
            _shifts.AddRange(result ?? Array.Empty<Shift>());
        }
        finally
        {
            _isLoadingShifts = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnSearchAsync()
    {
        @* Wired up filters/search to re-query shifts *@
        await LoadShiftsAsync();
    }

    private async Task OnReset()
    {
        _searchText = string.Empty;
        var today = DateTime.Today;
        _selectedMonth = new DateTime(today.Year, today.Month, 1);
        _weekStart = StartOfWeek(today);

        if (_isAdmin)
        {
            SelectedGroup = "All";
            _selectedEmployeeId = null;
        }
        else if (_currentEmployeeId.HasValue)
        {
            _selectedEmployeeId = _currentEmployeeId;
            var self = _employees.FirstOrDefault();
            SelectedGroup = self != default ? self.Group : null;
        }
        else
        {
            SelectedGroup = null;
        }

        await LoadShiftsAsync();
    }

    private async Task OnMonthChanged(ChangeEventArgs e)
    {
        var value = Convert.ToString(e.Value, CultureInfo.InvariantCulture);
        if (string.IsNullOrWhiteSpace(value))
        {
            return;
        }

        if (DateTime.TryParseExact(value + "-01", "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var selected))
        {
            _selectedMonth = new DateTime(selected.Year, selected.Month, 1);
            _weekStart = StartOfWeek(_selectedMonth);
            await LoadShiftsAsync();
        }
    }

    private async Task GoToPreviousWeek()
    {
        _weekStart = _weekStart.AddDays(-7);
        _selectedMonth = new DateTime(_weekStart.Year, _weekStart.Month, 1);
        await LoadShiftsAsync();
    }

    private async Task GoToNextWeek()
    {
        _weekStart = _weekStart.AddDays(7);
        _selectedMonth = new DateTime(_weekStart.Year, _weekStart.Month, 1);
        await LoadShiftsAsync();
    }

    private IEnumerable<DateTime> GetWeekDays()
    {
        for (var i = 0; i < 7; i++)
        {
            yield return _weekStart.AddDays(i);
        }
    }

    private void EnsureEmployeeWithinGroup()
    {
        if (string.IsNullOrWhiteSpace(_selectedGroup) || _selectedGroup == "All")
        {
            return;
        }

        if (_selectedEmployeeId.HasValue)
        {
            var match = _employees.Any(e => e.Id == _selectedEmployeeId && string.Equals(e.Group, _selectedGroup, StringComparison.OrdinalIgnoreCase));
            if (!match)
            {
                _selectedEmployeeId = null;
            }
        }
    }

    private static DateTime StartOfWeek(DateTime date)
    {
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return date.Date.AddDays(-diff);
    }

    private string GetWeekRangeLabel()
    {
        var end = _weekStart.AddDays(6);
        if (_weekStart.Month == end.Month)
        {
            return $"{_weekStart:MMMM d} – {end:MMMM d, yyyy}";
        }

        return $"{_weekStart:MMM d} – {end:MMM d, yyyy}";
    }

    private void CreateShift()
    {
        if (!_isAdmin || _employees.Count == 0)
        {
            return;
        }

        var targetDate = GetDefaultShiftDate();
        var defaultStart = targetDate.AddHours(9);
        var defaultEnd = defaultStart.AddHours(8);

        var selectedEmployee = _employees.FirstOrDefault(e =>
            _selectedEmployeeId.HasValue && e.Id == _selectedEmployeeId.Value);

        if (selectedEmployee == default)
        {
            selectedEmployee = _employees.FirstOrDefault(e =>
                _selectedGroup is null ||
                _selectedGroup == "All" ||
                string.Equals(e.Group, _selectedGroup, StringComparison.OrdinalIgnoreCase));
        }

        if (selectedEmployee == default)
        {
            selectedEmployee = _employees[0];
        }

        var employeeId = selectedEmployee.Id;
        var employeeName = ResolveEmployeeName(employeeId);
        var group = ResolveGroupForEmployee(employeeId) ?? (_selectedGroup is null || _selectedGroup == "All" ? null : _selectedGroup);

        _editingShift = new Shift
        {
            EmployeeId = employeeId,
            EmployeeName = employeeName ?? string.Empty,
            Start = defaultStart,
            End = defaultEnd,
            GroupName = group
        };

        _modalError = null;
        _isNewShift = true;
        _isModalOpen = true;
    }

    private void OnShiftSelected(Shift shift)
    {
        if (!_isAdmin)
        {
            return;
        }

        _editingShift = new Shift
        {
            Id = shift.Id,
            EmployeeId = shift.EmployeeId,
            EmployeeName = shift.EmployeeName,
            Start = shift.Start,
            End = shift.End,
            GroupName = shift.GroupName
        };

        _modalError = null;
        _isNewShift = false;
        _isModalOpen = true;
    }

    private async Task OnModalSave(Shift model)
    {
        if (!_isAdmin)
        {
            return;
        }

        _isModalBusy = true;
        try
        {
            _modalError = null;

            if (_isNewShift)
            {
                await ShiftService.InsertShiftAsync(model);
            }
            else
            {
                await ShiftService.UpdateShiftAsync(model);
            }

            _isModalOpen = false;
            _editingShift = null;
            await LoadShiftsAsync();
        }
        catch (Exception ex)
        {
            _modalError = ex.Message;
            _editingShift = model;
        }
        finally
        {
            _isModalBusy = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Task OnModalCancel()
    {
        _modalError = null;
        _isModalOpen = false;
        _editingShift = null;
        return Task.CompletedTask;
    }

    private Task OnModalOpenChanged(bool isOpen)
    {
        _isModalOpen = isOpen;
        if (!isOpen)
        {
            _modalError = null;
            _editingShift = null;
        }

        return Task.CompletedTask;
    }

    private async Task OnModalDelete(int shiftId)
    {
        if (!_isAdmin)
        {
            return;
        }

        _isModalBusy = true;
        try
        {
            _modalError = null;
            var deleted = await ShiftService.DeleteShiftAsync(shiftId);
            if (!deleted)
            {
                _modalError = "Shift could not be found.";
                return;
            }

            _isModalOpen = false;
            _editingShift = null;
            await LoadShiftsAsync();
        }
        catch (Exception ex)
        {
            _modalError = ex.Message;
        }
        finally
        {
            _isModalBusy = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private DateTime GetDefaultShiftDate()
    {
        var weekEnd = _weekStart.AddDays(7);
        if (DateTime.Today >= _weekStart && DateTime.Today < weekEnd)
        {
            return DateTime.Today;
        }

        return _weekStart;
    }

    private string? ResolveEmployeeName(int employeeId)
    {
        if (employeeId == 0)
        {
            return null;
        }

        var employee = _employees.FirstOrDefault(e => e.Id == employeeId);
        return employee == default ? null : employee.Name;
    }

    private string? ResolveGroupForEmployee(int employeeId)
    {
        if (employeeId == 0)
        {
            return null;
        }

        var employee = _employees.FirstOrDefault(e => e.Id == employeeId);
        return employee == default || string.IsNullOrWhiteSpace(employee.Group) ? null : employee.Group;
    }
}
