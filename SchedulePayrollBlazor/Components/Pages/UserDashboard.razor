@page "/userdashboard"
@attribute [Authorize(Roles = "Employee")]
@inject AppDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore
@using SchedulePayrollBlazor.Data.Models
@using System.Security.Claims

<div class="page">
    <header class="page-header">
        <div>
            <h1 class="page-title">Welcome, @employeeName!</h1>
            <p class="page-subtitle">Your schedule and payroll snapshot</p>
        </div>
    </header>

    <section class="metric-grid">
        <div class="metric-card purple">
            <div class="metric-icon">üìÖ</div>
            <div class="metric-content">
                <h3>@todaySchedules</h3>
                <p>Today's Shifts</p>
            </div>
        </div>

        <div class="metric-card blue">
            <div class="metric-icon">‚è∞</div>
            <div class="metric-content">
                <h3>@upcomingSchedules</h3>
                <p>Upcoming Shifts</p>
            </div>
        </div>

        <div class="metric-card green">
            <div class="metric-icon">üí∞</div>
            <div class="metric-content">
                <h3>$@lastPayAmount.ToString("N2")</h3>
                <p>Last Paycheck</p>
            </div>
        </div>

        <div class="metric-card orange">
            <div class="metric-icon">üìä</div>
            <div class="metric-content">
                <h3>@totalHoursThisWeek</h3>
                <p>Hours This Week</p>
            </div>
        </div>
    </section>

    <section class="content-card">
        <div class="card-header">
            <h3>Quick Actions</h3>
            <p>Access the tools you need most often.</p>
        </div>
        <div class="quick-actions">
            <a href="/myschedule" class="quick-card">
                <div class="quick-icon">üìÖ</div>
                <h4>My Schedule</h4>
                <p>View your work schedule</p>
            </a>

            <a href="/mypayroll" class="quick-card">
                <div class="quick-icon">üí∞</div>
                <h4>My Payroll</h4>
                <p>Review pay history and details</p>
            </a>
        </div>
    </section>

    <section class="content-card">
        <div class="card-header">
            <h3>Upcoming Shifts</h3>
            <p>Stay prepared for your next assignments.</p>
        </div>
        @if (upcomingShifts.Any())
        {
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var shift in upcomingShifts)
                        {
                            <tr>
                                <td>@shift.ShiftDate.ToString("MMM dd, yyyy")</td>
                                <td>@((DateTime.Today + shift.StartTime).ToString("hh\\:mm"))</td>
                                <td>@((DateTime.Today + shift.EndTime).ToString("hh\\:mm"))</td>
                                <td>@((shift.EndTime - shift.StartTime).TotalHours.ToString("F1")) hours</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info">No upcoming shifts scheduled.</div>
        }
    </section>
</div>

@code {
    private string employeeName = "";
    private int employeeId;
    private int todaySchedules;
    private int upcomingSchedules;
    private decimal lastPayAmount;
    private double totalHoursThisWeek;
    private List<Schedule> upcomingShifts = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        var role = user.FindFirst(ClaimTypes.Role)?.Value;
        if (!string.Equals(role, "Employee", StringComparison.OrdinalIgnoreCase))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        employeeName = user.FindFirst(ClaimTypes.Name)?.Value ?? "Team Member";
        var empIdClaim = user.FindFirst("EmployeeId")?.Value ?? user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!int.TryParse(empIdClaim, out employeeId))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        // Use DateTime consistently
        var today = DateTime.Today.Date;

        todaySchedules = await Db.Schedules
            .CountAsync(s => s.EmployeeId == employeeId && s.ShiftDate.Date == today);

        var tomorrow = today.AddDays(1);
        var nextWeek = today.AddDays(7);

        upcomingSchedules = await Db.Schedules
            .CountAsync(s =>
                s.EmployeeId == employeeId &&
                s.ShiftDate.Date >= tomorrow &&
                s.ShiftDate.Date <= nextWeek);

        upcomingShifts = await Db.Schedules
            .Where(s => s.EmployeeId == employeeId && s.ShiftDate.Date >= today)
            .OrderBy(s => s.ShiftDate)
            .ThenBy(s => s.StartTime)
            .Take(5)
            .ToListAsync();

        var lastPayroll = await Db.PayrollRuns
            .Where(p => p.EmployeeId == employeeId)
            .OrderByDescending(p => p.CreatedAt)
            .FirstOrDefaultAsync();

        lastPayAmount = lastPayroll?.NetPay ?? 0;

        // Start/end of current week (Sunday-based)
        var startOfWeek = today.AddDays(-(int)DateTime.Today.DayOfWeek);
        var endOfWeek = startOfWeek.AddDays(7);

        var weekSchedules = await Db.Schedules
            .Where(s =>
                s.EmployeeId == employeeId &&
                s.ShiftDate.Date >= startOfWeek &&
                s.ShiftDate.Date < endOfWeek)
            .ToListAsync();

        totalHoursThisWeek = weekSchedules.Sum(s => (s.EndTime - s.StartTime).TotalHours);
    }
}
