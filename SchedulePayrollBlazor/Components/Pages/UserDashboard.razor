@page "/userdashboard"
@attribute [Authorize(Roles = "Employee")]
@inject AppDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore
@using SchedulePayrollBlazor.Data.Models
@using System.Globalization
@using System.Security.Claims

<div class="ps-page">
    <div class="ps-page-header">
        <div>
            <h2>Welcome, @employeeName</h2>
            <p class="ps-subtitle">Your PaySync schedule snapshot.</p>
        </div>
    </div>

    <div class="ps-stat-grid">
        <div class="ps-stat-card">
            <span class="ps-stat-title">Today's shifts</span>
            <span class="ps-stat-value">@todayShiftCount</span>
        </div>
        <div class="ps-stat-card">
            <span class="ps-stat-title">Upcoming shifts</span>
            <span class="ps-stat-value">@upcomingShiftCount</span>
        </div>
        <div class="ps-stat-card">
            <span class="ps-stat-title">Hours this week</span>
            <span class="ps-stat-value">@totalHoursThisWeek.ToString("F1")</span>
        </div>
    </div>

    <section class="ps-card">
        <div class="ps-card-header">
            <h3>Quick links</h3>
            <p class="ps-subtitle">Access the areas you need most often.</p>
        </div>
        <div class="ps-quick-links">
            <a href="/my-schedule" class="ps-quick-link">
                <span class="ps-quick-title">My schedule</span>
                <span class="ps-quick-text">Review upcoming shifts</span>
            </a>
            <a href="/mypayroll" class="ps-quick-link">
                <span class="ps-quick-title">My payroll</span>
                <span class="ps-quick-text">View recent pay details</span>
            </a>
            <a href="/profile" class="ps-quick-link">
                <span class="ps-quick-title">Profile</span>
                <span class="ps-quick-text">Check your account information</span>
            </a>
        </div>
    </section>

    <section class="ps-card">
        <div class="ps-card-header">
            <h3>Upcoming shifts</h3>
            <p class="ps-subtitle">Stay prepared for what's next.</p>
        </div>
        @if (upcomingShifts.Any())
        {
            <div class="ps-table-container">
                <table class="ps-table">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Start</th>
                            <th scope="col">End</th>
                            <th scope="col">Duration</th>
                            <th scope="col">Group</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var shift in upcomingShifts)
                        {
                            <tr>
                                <td>@shift.Start.ToString("MMM dd, yyyy", CultureInfo.InvariantCulture)</td>
                                <td>@shift.Start.ToString("hh:mm tt", CultureInfo.InvariantCulture)</td>
                                <td>@shift.End.ToString("hh:mm tt", CultureInfo.InvariantCulture)</td>
                                <td>@((shift.End - shift.Start).TotalHours.ToString("F1")) hours</td>
                                <td>@(string.IsNullOrWhiteSpace(shift.GroupName) ? "Unassigned" : shift.GroupName)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-muted">No upcoming shifts scheduled.</div>
        }
    </section>
</div>

@code {
    private string employeeName = "";
    private int employeeId;
    private int todayShiftCount;
    private int upcomingShiftCount;
    private double totalHoursThisWeek;
    private List<Shift> upcomingShifts = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        var role = user.FindFirst(ClaimTypes.Role)?.Value;
        if (!string.Equals(role, "Employee", StringComparison.OrdinalIgnoreCase))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        employeeName = user.FindFirst(ClaimTypes.Name)?.Value ?? "Team Member";
        var empIdClaim = user.FindFirst("EmployeeId")?.Value ?? user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!int.TryParse(empIdClaim, out employeeId))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        var today = DateTime.Today.Date;
        var tomorrow = today.AddDays(1);
        var weekEndExclusive = tomorrow.AddDays(7);

        todayShiftCount = await Db.Shifts
            .CountAsync(s => s.EmployeeId == employeeId && s.Start >= today && s.Start < tomorrow);

        upcomingShiftCount = await Db.Shifts
            .CountAsync(s =>
                s.EmployeeId == employeeId &&
                s.Start >= tomorrow &&
                s.Start < weekEndExclusive);

        upcomingShifts = await Db.Shifts
            .Where(s => s.EmployeeId == employeeId && s.Start >= today)
            .OrderBy(s => s.Start)
            .Take(5)
            .ToListAsync();

        var startOfWeek = GetWeekStart(today);
        var endOfWeek = startOfWeek.AddDays(7);

        var weekShifts = await Db.Shifts
            .Where(s =>
                s.EmployeeId == employeeId &&
                s.Start >= startOfWeek &&
                s.Start < endOfWeek)
            .ToListAsync();

        totalHoursThisWeek = weekShifts.Sum(s => (s.End - s.Start).TotalHours);
    }

    private static DateTime GetWeekStart(DateTime date)
    {
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return date.Date.AddDays(-diff);
    }
}
