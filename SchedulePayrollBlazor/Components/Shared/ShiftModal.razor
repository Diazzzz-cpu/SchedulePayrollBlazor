@using System.Globalization
@using SchedulePayrollBlazor.Data
@using SchedulePayrollBlazor.Services.Models
@implements IDisposable
@inject AppDbContext Db

@if (IsOpen && _editContext is not null)
{
    <div class="ps-modal-backdrop">
        <div class="ps-modal" @onclick:stopPropagation>
            <div class="ps-modal-header">
                <div>
                    <h3>@Title</h3>
                    @if (!string.IsNullOrWhiteSpace(_formModel.EmployeeName))
                    {
                        <p class="ps-modal-subtitle">@_formModel.EmployeeName</p>
                    }
                </div>
                <button type="button" class="ps-modal-close" @onclick="CancelAsync" aria-label="Close">×</button>
            </div>
            <div class="ps-modal-body">
                <EditForm EditContext="_editContext" OnValidSubmit="HandleValidSubmit">
                    <ValidationSummary />

                    @if (!string.IsNullOrWhiteSpace(ErrorMessage))
                    {
                        <div class="ps-alert ps-alert-danger">@ErrorMessage</div>
                    }

                    @if (!string.IsNullOrWhiteSpace(SuccessMessage))
                    {
                        <div class="ps-alert ps-alert-success">@SuccessMessage</div>
                    }

                    <div class="ps-form-grid">
                        <div class="form-group">
                            <label class="ps-label" for="shift-modal-employee">Employee</label>
                            <select id="shift-modal-employee"
                                    class="ps-input"
                                    value="@(_formModel.EmployeeId == 0 ? string.Empty : _formModel.EmployeeId.ToString(CultureInfo.InvariantCulture))"
                                    @onchange="OnEmployeeChanged">
                                <option value="">Select employee</option>
                                @foreach (var employee in Employees)
                                {
                                    <option value="@employee.Id">@employee.Name</option>
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="ps-label" for="shift-modal-date">Date</label>
                            <InputDate @bind-Value="_formModel.Date"
                                       id="shift-modal-date"
                                       class="ps-input" />
                        </div>

                        <div class="form-group">
                            <label class="ps-label" for="shift-modal-start">Start time</label>
                            <input id="shift-modal-start"
                                   type="time"
                                   class="ps-input"
                                   value="@_formModel.GetStartTimeText()"
                                   step="300"
                                   @onchange="OnStartChanged" />
                        </div>

                        <div class="form-group">
                            <label class="ps-label" for="shift-modal-end">End time</label>
                            <input id="shift-modal-end"
                                   type="time"
                                   class="ps-input"
                                   value="@_formModel.GetEndTimeText()"
                                   step="300"
                                   @onchange="OnEndChanged" />
                        </div>

                        <div class="form-group">
                            <label class="ps-label" for="shift-modal-group">Group</label>
                            @* Group dropdown fed from Employees.Department *@
                            <InputSelect id="shift-modal-group"
                                         class="ps-input"
                                         @bind-Value="_formModel.GroupName">
                                <option value="">Select group</option>
                                @if (_groupOptions is not null)
                                {
                                    @foreach (var g in _groupOptions)
                                    {
                                        <option value="@g">@g</option>
                                    }
                                }
                            </InputSelect>
                        </div>
                    </div>

                    <div class="ps-form-grid">
                        <div class="form-group">
                            <label class="ps-label" for="shift-modal-repeat-mode">Repeat</label>
                            <InputSelect id="shift-modal-repeat-mode"
                                         class="ps-input"
                                         @bind-Value="_formModel.RepeatMode">
                                <option value="@ShiftRepeatMode.None">Do not repeat</option>
                                <option value="@ShiftRepeatMode.Weekly">Weekly</option>
                                <option value="@ShiftRepeatMode.Weekdays">Weekdays (Mon–Fri)</option>
                                <option value="@ShiftRepeatMode.CustomDays">Custom days</option>
                            </InputSelect>
                        </div>

                        <div class="form-group">
                            <label class="ps-label" for="shift-modal-repeat-until">Repeat until</label>
                            <InputDate @bind-Value="_formModel.RepeatUntil"
                                       id="shift-modal-repeat-until"
                                       class="ps-input"
                                       disabled="@(_formModel.RepeatMode == ShiftRepeatMode.None)" />
                        </div>
                    </div>

                    @if (_formModel.RepeatMode == ShiftRepeatMode.CustomDays)
                    {
                        <div class="form-group">
                            <label class="ps-label">Repeat on</label>
                            <div class="ps-checkbox-row">
                                @foreach (var day in _orderedDays)
                                {
                                    var isChecked = _formModel.RepeatDays.Contains(day);
                                    <label class="ps-checkbox">
                                        <input type="checkbox"
                                               checked="@isChecked"
                                               @onchange="args => ToggleRepeatDay(day, args)" />
                                        <span>@day.ToString().Substring(0, 3)</span>
                                    </label>
                                }
                            </div>
                        </div>
                    }

                    <div class="shift-modal-footer">
                        @if (OnDelete.HasDelegate && _formModel.Id.HasValue)
                        {
                            <button type="button" class="ps-button ps-button-danger" @onclick="DeleteAsync" disabled="@(_isSubmitting || IsBusy)">
                                Delete shift
                            </button>
                        }
                        <div class="shift-modal-footer-actions">
                            <button type="button" class="ps-button ps-button-ghost" @onclick="CancelAsync" disabled="@(_isSubmitting || IsBusy)">Cancel</button>
                            <button type="submit" class="ps-button ps-button-primary" disabled="@(_isSubmitting || IsBusy)">Save shift</button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private bool _initializedForOpen;
    private ShiftEditorModel _formModel = ShiftEditorModel.CreateDefault();
    private EditContext? _editContext;
    private ValidationMessageStore? _validationMessages;
    private bool _isSubmitting;
    private readonly DayOfWeek[] _orderedDays = new[]
    {
        DayOfWeek.Sunday,
        DayOfWeek.Monday,
        DayOfWeek.Tuesday,
        DayOfWeek.Wednesday,
        DayOfWeek.Thursday,
        DayOfWeek.Friday,
        DayOfWeek.Saturday
    };

    // department / group list loaded from DB
    private List<string> _groupOptions = new();

    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public Shift? Model { get; set; }
    [Parameter] public IEnumerable<(int Id, string Name)> Employees { get; set; } = Enumerable.Empty<(int, string)>();
    [Parameter] public EventCallback<ShiftSaveRequest> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public string Title { get; set; } = "Create shift";
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public string? SuccessMessage { get; set; }
    [Parameter] public bool IsBusy { get; set; }

    protected override void OnParametersSet()
    {
        if (!IsOpen)
        {
            if (_initializedForOpen)
            {
                TearDownEditContext();
                _initializedForOpen = false;
            }

            return;
        }

        if (!_initializedForOpen)
        {
            InitializeEditContext();
            _initializedForOpen = true;
        }
    }

    private void InitializeEditContext()
    {
        // Load group/department options once when modal first opens
        if (_groupOptions.Count == 0)
        {
            try
            {
                _groupOptions = Db.Employees
                    .Where(e => !string.IsNullOrWhiteSpace(e.Department))
                    .Select(e => e.Department!)
                    .Distinct()
                    .OrderBy(d => d)
                    .ToList();
            }
            catch
            {
                _groupOptions = new();
            }
        }

        var model = Model is not null
            ? ShiftEditorModel.FromShift(Model)
            : ShiftEditorModel.CreateDefault();

        if (model.EmployeeId == 0)
        {
            var first = Employees.FirstOrDefault();
            if (first.Id != 0)
            {
                model.EmployeeId = first.Id;
                model.EmployeeName = first.Name;
            }
        }
        else if (string.IsNullOrWhiteSpace(model.EmployeeName))
        {
            model.EmployeeName = ResolveEmployeeName(model.EmployeeId);
        }

        // If no group yet and we have options, default to the first one
        if (string.IsNullOrWhiteSpace(model.GroupName) && _groupOptions.Any())
        {
            model.GroupName = _groupOptions[0];
        }

        ResetEditContext(model);
    }

    private void ResetEditContext(ShiftEditorModel model)
    {
        TearDownEditContext();

        _formModel = model;
        _editContext = new EditContext(_formModel);
        _validationMessages = new ValidationMessageStore(_editContext);
        _editContext.OnValidationRequested += HandleValidationRequested;
        _editContext.OnFieldChanged += HandleFieldChanged;
    }

    private void TearDownEditContext()
    {
        if (_editContext is not null)
        {
            _editContext.OnValidationRequested -= HandleValidationRequested;
            _editContext.OnFieldChanged -= HandleFieldChanged;
        }

        _validationMessages = null;
        _editContext = null;
    }

    private async Task HandleValidSubmit()
    {
        if (_editContext is null)
        {
            return;
        }

        _isSubmitting = true;
        try
        {
            var saveRequest = _formModel.ToSaveRequest();
            await OnSave.InvokeAsync(saveRequest);
        }
        finally
        {
            _isSubmitting = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task CancelAsync()
    {
        if (_isSubmitting || IsBusy)
        {
            return;
        }

        await InvokeAsync(async () =>
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }

            if (IsOpenChanged.HasDelegate)
            {
                await IsOpenChanged.InvokeAsync(false);
            }
        });
    }

    private async Task DeleteAsync()
    {
        if (!OnDelete.HasDelegate || !_formModel.Id.HasValue)
        {
            return;
        }

        _isSubmitting = true;
        try
        {
            await OnDelete.InvokeAsync(_formModel.Id.Value);
        }
        finally
        {
            _isSubmitting = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        if (_validationMessages is null || _editContext is null)
        {
            return;
        }

        _validationMessages.Clear();

        var employeeField = new FieldIdentifier(_formModel, nameof(ShiftEditorModel.EmployeeId));
        var dateField = new FieldIdentifier(_formModel, nameof(ShiftEditorModel.Date));
        var startField = new FieldIdentifier(_formModel, nameof(ShiftEditorModel.StartTime));
        var endField = new FieldIdentifier(_formModel, nameof(ShiftEditorModel.EndTime));
        var repeatModeField = new FieldIdentifier(_formModel, nameof(ShiftEditorModel.RepeatMode));
        var repeatUntilField = new FieldIdentifier(_formModel, nameof(ShiftEditorModel.RepeatUntil));

        if (_formModel.EmployeeId <= 0 || !Employees.Any(e => e.Id == _formModel.EmployeeId))
        {
            _validationMessages.Add(employeeField, "Select an employee.");
        }

        if (_formModel.Date == default)
        {
            _validationMessages.Add(dateField, "Select a valid date.");
        }

        if (_formModel.EndTime <= _formModel.StartTime)
        {
            _validationMessages.Add(endField, "End time must be after the start time.");
        }

        if (_formModel.RepeatMode != ShiftRepeatMode.None)
        {
            if (!_formModel.RepeatUntil.HasValue)
            {
                _validationMessages.Add(repeatUntilField, "Set an end date for repeating.");
            }
            else if (_formModel.RepeatUntil.Value.Date < _formModel.Date.Date)
            {
                _validationMessages.Add(repeatUntilField, "Repeat until date must be on or after the start date.");
            }

            if (_formModel.RepeatMode == ShiftRepeatMode.CustomDays && _formModel.RepeatDays.Count == 0)
            {
                _validationMessages.Add(repeatModeField, "Select at least one day for custom repeat.");
            }
        }

        _editContext.NotifyValidationStateChanged();
    }

    private void HandleFieldChanged(object? sender, FieldChangedEventArgs args)
    {
        if (_validationMessages is null)
        {
            return;
        }

        _validationMessages.Clear(args.FieldIdentifier);

        if (args.FieldIdentifier.FieldName == nameof(ShiftEditorModel.EmployeeId))
        {
            _formModel.EmployeeName = ResolveEmployeeName(_formModel.EmployeeId);
        }
    }

    private void OnEmployeeChanged(ChangeEventArgs e)
    {
        var value = Convert.ToString(e.Value, CultureInfo.InvariantCulture);
        if (int.TryParse(value, NumberStyles.Integer, CultureInfo.InvariantCulture, out var employeeId))
        {
            _formModel.EmployeeId = employeeId;
            _formModel.EmployeeName = ResolveEmployeeName(employeeId);
        }
        else
        {
            _formModel.EmployeeId = 0;
            _formModel.EmployeeName = null;
        }

        _editContext?.NotifyFieldChanged(new FieldIdentifier(_formModel, nameof(ShiftEditorModel.EmployeeId)));
    }

    private void OnStartChanged(ChangeEventArgs e)
    {
        var value = Convert.ToString(e.Value, CultureInfo.InvariantCulture);

        if (!string.IsNullOrWhiteSpace(value) &&
            TimeSpan.TryParse(value, CultureInfo.InvariantCulture, out var time))
        {
            _formModel.StartTime = time;
        }

        _editContext?.NotifyFieldChanged(new FieldIdentifier(_formModel, nameof(ShiftEditorModel.StartTime)));
    }

    private void OnEndChanged(ChangeEventArgs e)
    {
        var value = Convert.ToString(e.Value, CultureInfo.InvariantCulture);

        if (!string.IsNullOrWhiteSpace(value) &&
            TimeSpan.TryParse(value, CultureInfo.InvariantCulture, out var time))
        {
            _formModel.EndTime = time;
        }

        _editContext?.NotifyFieldChanged(new FieldIdentifier(_formModel, nameof(ShiftEditorModel.EndTime)));
    }

    private void ToggleRepeatDay(DayOfWeek day, ChangeEventArgs e)
    {
        var isChecked = e?.Value is bool boolean && boolean;
        if (isChecked)
        {
            _formModel.RepeatDays.Add(day);
        }
        else
        {
            _formModel.RepeatDays.Remove(day);
        }

        _editContext?.NotifyFieldChanged(new FieldIdentifier(_formModel, nameof(ShiftEditorModel.RepeatDays)));
    }

    private string? ResolveEmployeeName(int employeeId)
    {
        var match = Employees.FirstOrDefault(e => e.Id == employeeId);
        return match == default ? null : match.Name;
    }

    private sealed class ShiftEditorModel
    {
        public int? Id { get; set; }
        public int EmployeeId { get; set; }
        public string? EmployeeName { get; set; }
        public DateTime Date { get; set; } = DateTime.Today;
        public TimeSpan StartTime { get; set; } = TimeSpan.FromHours(9);
        public TimeSpan EndTime { get; set; } = TimeSpan.FromHours(17);
        public string? GroupName { get; set; }
        public ShiftRepeatMode RepeatMode { get; set; }
        public DateTime? RepeatUntil { get; set; }
        public HashSet<DayOfWeek> RepeatDays { get; } = new();

        public static ShiftEditorModel CreateDefault() => new();

        public static ShiftEditorModel FromShift(Shift shift)
        {
            return new ShiftEditorModel
            {
                Id = shift.Id,
                EmployeeId = shift.EmployeeId,
                EmployeeName = shift.EmployeeName,
                Date = shift.Start.Date,
                StartTime = shift.Start.TimeOfDay,
                EndTime = shift.End.TimeOfDay,
                GroupName = shift.GroupName
            };
        }

        public ShiftSaveRequest ToSaveRequest()
        {
            var baseDateLocal = DateTime.SpecifyKind(Date.Date, DateTimeKind.Local);

            var shift = new Shift
            {
                Id = Id ?? 0,
                EmployeeId = EmployeeId,
                EmployeeName = EmployeeName ?? string.Empty,
                Start = baseDateLocal.Add(StartTime),
                End = baseDateLocal.Add(EndTime),
                GroupName = string.IsNullOrWhiteSpace(GroupName) ? null : GroupName.Trim()
            };

            var repeatRequest = new ShiftRepeatRequest
            {
                RepeatMode = RepeatMode,
                RepeatUntil = RepeatUntil.HasValue
                    ? DateOnly.FromDateTime(RepeatUntil.Value.Date)
                    : null,
                RepeatDays = RepeatMode == ShiftRepeatMode.CustomDays
                    ? new List<DayOfWeek>(RepeatDays)
                    : Array.Empty<DayOfWeek>()
            };

            return new ShiftSaveRequest
            {
                Shift = shift,
                RepeatRequest = repeatRequest
            };
        }

        public string GetStartTimeText() =>
            string.Format(CultureInfo.InvariantCulture, "{0:hh\\:mm}", StartTime);

        public string GetEndTimeText() =>
            string.Format(CultureInfo.InvariantCulture, "{0:hh\\:mm}", EndTime);
    }

    public void Dispose()
    {
        TearDownEditContext();
    }
}
